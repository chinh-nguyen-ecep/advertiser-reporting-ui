<html xmlns:xf="http://www.w3.org/2002/xforms">
   <head>
	<!-- do not include a <meta> tag -->
      <link rel="stylesheet" type="text/css" href="/pentaho-style/active/default.css"></link>
      <title id="exportFileName">Daily VLMO by Offer</title>
	  <link  href="/verve_style/css/tableInForm.css" rel="stylesheet" type="text/css" media="screen" />
	  <link  href="/verve_style/css/charttool.css" rel="stylesheet" type="text/css" media="screen" />
	  <link rel="stylesheet" type="text/css" href="/verve_style/scripts2/easyui/themes/metro/easyui.css" />
	  <link rel="stylesheet" type="text/css" href="/verve_style/scripts2/easyui/themes/icon.css" />
	  <link rel="stylesheet" type="text/css" href="/verve_style/scripts2/datetimepicker/jquery.datetimepicker.css" />
	  <link rel="stylesheet" type="text/css" href="/verve_style/scripts2/checkbox/jquery.checkbox.css" />
	  <link rel="stylesheet" type="text/css" href="/verve_style/scripts2/checkbox/jquery.safari-checkbox.css" />
	  <script src="/verve_style/scripts2/jquery.min.js"></script>	
	  <script src="/verve_style/scripts2/easyui/easyloader.js"></script>		
	  <script src="/verve_style/scripts2/easyui/jquery.easyui.min.js"></script>
	  <script src="/verve_style/scripts2/datetimepicker/jquery.datetimepicker.js"></script>
	  <script src="/verve_style/scripts2/checkbox/jquery.checkbox.min.js"></script>
	  <script src="/verve_style/scripts2/utils.js"></script>			  
      		
	{xform-header}

   </head>
   <body style="background-color: #fff">
   <div id="toolbar2">	   
		   <div class="leftGroup">
		   <img id="open" title="Open control panel" src="/verve_style/images/preferences_system_windows_actions.png"/>		   
		   </div>	  
   </div>
      <div class="easyui-dialog" title="Daily VLMO by Offer" data-options="iconCls:'icon-tip',resizable:false,modal:true,deltaX: 10" id="mydiv">
         <form name="parameter-form" id="parameter-form" method="GET">
         <table class="tableForm">
         <tbody>	         
			 <tr>
		         <th>Date mode:</th>
		         <td><div style="float: left;">{p_date_mode}</div>
		         </td>
	         </tr>
	         <tr>
		         <th>Range from:</th>
		         <td>
					<div id="datemode" style="float: left;">
						 <label style="margin-left: 0px;"></label> {p_start_date}
						 <label style="margin-left: 0px;">To:</label> {p_end_date}
					</div>
		             <div id="monthmode" style="display: none;float: left;">
		             <label style="margin-left: 0px;"></label> {p_start_month_since_2005}
		             <label style="margin-left: 0px;">To:</label> {p_end_month_since_2005}
		             </div>	             
		        </td>
	         </tr>  
         </tbody>
         </table>
		 
		 
         <div id="switch_control" >
			<table class="tableForm">
			 <tbody>		 
					<tr>
						 <th>Agency:</th>
						 <td>
							<input id="dimesion_fillter" type="text" style="width: 300px;"/>
							<div id="dimesion" style="width: 290px;border: 1px solid gray;overflow: auto;height: 100px;padding: 5px;">
							</div>
						 </td>
					 </tr>	
					<tr>
						 <th>Merchant:</th>
						 <td>
							<input id="dimesion_merchant" type="text" style="width: 300px;"/>
							<div id="merchant" style="width: 290px;border: 1px solid gray;overflow: auto;height: 100px;padding: 5px;">
							</div>
						 </td>
					 </tr>	
					<tr>
						 <th>Offer:</th>
						 <td>
							<input id="dimesion_offer" type="text" style="width: 300px;"/>
							<div id="offer" style="width: 290px;border: 1px solid gray;overflow: auto;height: 100px;padding: 5px;">
							</div>
						 </td>
					 </tr>	
			</tbody>
		 </table>
		</div>
			
		<table class="tableForm">
         <tbody>
			<tr id="tr_bt">
				<th>Output type: </th>
				<td>
				{p_output}<input type="button" style="cursor: pointer;margin-left: 5px" name="go" class="portlet-form-button" value="Run" onClick="validation()"/>
				</td>
				 
	         </tr>
		 </tbody>
		 </table>
		 <div style="display: none">
        {v_max_date}
		{v_min_date} 
		{solution}
		{action}
		{path}		 
		 </div>
	    </form>
      </div>    
   
   <iframe id="mainFrame" width="100%" height="100%" name="theoutput" frameborder="0" scrolling="yes" style="overflow-x:hidden;"></iframe>

	
	<script> 
	var mySearch;
	var mySearch2;
	var mySearch3;
	$( document ).ready(function() {
		console.log(  $().jquery );
		//Remove all Choose value of select 
		$('option[value=]').remove();
		$('#open').click(function(){
			$('#mydiv').dialog('open');
		});
		//Init date picker
		var start_date=new Date(new Date($('#v_max_date').val()).setDate(new Date($('#v_max_date').val()).getDate()-2));;
		var start_date=myformatter(start_date);
		console.log(start_date);
		$('input[name=p_start_date]').datetimepicker({
			value: start_date,
			timepicker:false,
			format: 'Y-m-d',
			validateOnBlur: false,
			formatDate:'Y-m-d',
			minDate: $('#v_min_date').val(),
			maxDate: $('#v_max_date').val()
		});
		$('input[name=p_end_date]').datetimepicker({
			value: $('#v_max_date').val(),
			timepicker:false,
			format: 'Y-m-d',
			formatDate:'Y-m-d',
			validateOnBlur: false,
			minDate: $('#v_min_date').val(),
			maxDate: $('#v_max_date').val()
		});
		//Month select
		$('input[name=p_date_mode]').change(function(){
		
			var isChecked=$(this).is(':checked');
			console.log(isChecked);
			if(isChecked){
				var dateMode=$(this).val();
				if(dateMode=='date'){
					$('#datemode').show();
					$('#monthmode').hide();
				}else{
					$('#datemode').hide();
					$('#monthmode').show();
				}
			}
			
		});
		//Agency check box
		mySearch=new generateSelect2({
			inputID: 'dimesion_fillter',
			divID: 'dimesion',
			name: 'p_agency_id',
			multi: false,
			ajaxUrl: '/pentaho/ViewAction',
			data: function(term,page){
				return {
					solution: solution,
					path: path+'/daily_vlmo_by_offer',
					mode: 'loadDimensions',
					action: 'loadDimension.xaction',
					term: term, //search term
					limit: 10, // page size
					page: page, // page number
					mode: 'agency'
				};
			},
			result: function(data, page){
				var results=data.data;
				var more=false;
				if(results.length==data.limit){
					more=true
				}
				return {results: results,more: more}
			},
			success: function(){
				mySearch2.action();
			},
			clickEvent: function(id){
				mySearch2.action();
			}
		});
		mySearch.action();
		//Merchant check box
		mySearch2=new generateSelect2({
			inputID: 'dimesion_merchant',
			divID: 'merchant',
			name: 'merchant_id',
			multi: true,
			selectAll: true,
			ajaxUrl: '/pentaho/ViewAction',
			data: function(term,page){
				return {
					solution: solution,
					path: path+'/daily_vlmo_by_offer',
					mode: 'loadDimensions',
					action: 'loadDimension.xaction',
					term: term, //search term
					limit: 10, // page size
					page: page, // page number
					mode: 'merchant',
					network_id: mySearch.getID()[0]
				};
			},
			result: function(data, page){
				var results=data.data;
				var more=false;
				if(results.length==data.limit){
					more=true
				}
				return {results: results,more: more}
			},
			success: function(){
				mySearch3.action();
			},
			clickEvent: function(id){
				mySearch3.action();
			}
		});    
		//offer check box
		mySearch3=new generateSelect2({
			inputID: 'dimesion_offer',
			divID: 'offer',
			name: 'offer_id',
			multi: true,
			selectAll: true,
			ajaxUrl: '/pentaho/ViewAction',
			data: function(term,page){
				return {
					solution: solution,
					path: path+'/daily_vlmo_by_offer',
					mode: 'loadDimensions',
					action: 'loadDimension.xaction',
					term: term, //search term
					limit: 10, // page size
					page: page, // page number
					mode: 'offer',
					merchant_ids: mySearch2.getID().join(","),
					network_id: mySearch.getID()[0]
				};
			},
			result: function(data, page){
				var results=data.data;
				var more=false;
				if(results.length==data.limit){
					more=true
				}
				return {results: results,more: more}
			}
		});
	}); 
	function validation(){
		var dateMode=$('input[name=p_date_mode]:checked').val();
		var agency_id=mySearch.getID().join();
		var merchant_ids=mySearch2.getID().join(",");
		var offer_ids=mySearch3.getID().join(",");
		var start_date=$('#p_start_date').val();
		var end_date=$('#p_end_date').val();
		
		if(dateMode=='date'){
			if(start_date==''||end_date==''||agency_id==''||merchant_ids==''||offer_ids==''){
				return false;
			}
		}else{
			if(agency_id==''||merchant_ids==''||offer_ids==''){
				return false;
			}
		}
		
		
		var urlData={			
			p_agency_id: agency_id,
			p_merchant_ids: merchant_ids,
			p_offer_ids: offer_ids			
		}
		//set title page
		$('#exportFileName').html('Daily VLMO by Offer '+start_date+' '+end_date);
		urlData=$.extend({},$( "#parameter-form" ).serializeObject(),urlData); 
		var url='/pentaho/ViewAction?'+$.param(urlData);
		$('#mydiv').dialog('close');
		$('#mainFrame').attr('src',url);
		return true;
	}
    </script>
   </body>
     
</html>
