/**
 * 
 */
var dmaArray=["662|ABILENE-SWEETWATER","532|ALBANY-SCHENECTADY-TROY","525|ALBANY, GA","790|ALBUQUERQUE-SANTA FE","644|ALEXANDRIA, LA","583|ALPENA","634|AMARILLO","743|ANCHORAGE","524|ATLANTA","520|AUGUSTA-AIKEN","635|AUSTIN","800|BAKERSFIELD","512|BALTIMORE","537|BANGOR","716|BATON ROUGE","692|BEAUMONT-PORT ARTHUR","821|BEND, OR","756|BILLINGS","746|BILOXI-GULFPORT","502|BINGHAMTON","630|BIRMINGHAM (ANN AND TUSC)","559|BLUEFIELD-BECKLEY-OAK HILL","757|BOISE","506|BOSTON (MANCHESTER)","736|BOWLING GREEN","514|BUFFALO","523|BURLINGTON-PLATTSBURGH","754|BUTTE-BOZEMAN","767|CASPER-RIVERTON","637|CEDAR RAPIDS-WTRLO-IWC&DUB","648|CHAMPAIGN&SPRNGFLD-DECATUR","564|CHARLESTON-HUNTINGTON","519|CHARLESTON, SC","517|CHARLOTTE","584|CHARLOTTESVILLE","575|CHATTANOOGA","759|CHEYENNE-SCOTTSBLUF","602|CHICAGO","868|CHICO-REDDING","515|CINCINNATI","598|CLARKSBURG-WESTON","510|CLEVELAND-AKRON (CANTON)","752|COLORADO SPRINGS-PUEBLO","604|COLUMBIA-JEFFERSON CITY","546|COLUMBIA, SC","673|COLUMBUS-TUPELO-W PNT-HSTN","522|COLUMBUS, GA (OPELIKA, AL)","535|COLUMBUS, OH","600|CORPUS CHRISTI","623|DALLAS-FT. WORTH","682|DAVENPORT-R.ISLAND-MOLINE","542|DAYTON","751|DENVER","679|DES MOINES-AMES","505|DETROIT","606|DOTHAN","676|DULUTH-SUPERIOR","765|EL PASO (LAS CRUCES)","565|ELMIRA (CORNING)","516|ERIE","801|EUGENE","802|EUREKA","649|EVANSVILLE","745|FAIRBANKS","724|FARGO-VALLEY CITY","513|FLINT-SAGINAW-BAY CITY","866|FRESNO-VISALIA","571|FT. MYERS-NAPLES","670|FT. SMITH-FAY-SPRNGDL-RGRS","509|FT. WAYNE","592|GAINESVILLE","798|GLENDIVE","773|GRAND JUNCTION-MONTROSE","563|GRAND RAPIDS-KALMZOO-B.CRK","755|GREAT FALLS","658|GREEN BAY-APPLETON","518|GREENSBORO-H.POINT-W.SALEM","545|GREENVILLE-N.BERN-WASHNGTN","567|GREENVLL-SPART-ASHEVLL-AND","647|GREENWOOD-GREENVILLE","636|HARLINGEN-WSLCO-BRNSVL-MCA","566|HARRISBURG-LNCSTR-LEB-YORK","569|HARRISONBURG","533|HARTFORD & NEW HAVEN","710|HATTIESBURG-LAUREL","766|HELENA","744|HONOLULU","618|HOUSTON","691|HUNTSVILLE-DECATUR (FLOR)","758|IDAHO FALS-POCATLLO(JCKSN)","527|INDIANAPOLIS","718|JACKSON, MS","639|JACKSON, TN","561|JACKSONVILLE","574|JOHNSTOWN-ALTOONA-ST COLGE","734|JONESBORO","603|JOPLIN-PITTSBURG","747|JUNEAU","616|KANSAS CITY","557|KNOXVILLE","702|LA CROSSE-EAU CLAIRE","582|LAFAYETTE, IN","642|LAFAYETTE, LA","643|LAKE CHARLES","551|LANSING","749|LAREDO","839|LAS VEGAS","541|LEXINGTON","558|LIMA","722|LINCOLN & HASTINGS-KRNY","693|LITTLE ROCK-PINE BLUFF","803|LOS ANGELES","529|LOUISVILLE","651|LUBBOCK","503|MACON","669|MADISON","737|MANKATO","553|MARQUETTE","813|MEDFORD-KLAMATH FALLS","640|MEMPHIS","711|MERIDIAN","528|MIAMI-FT. LAUDERDALE","617|MILWAUKEE","613|MINNEAPOLIS-ST. PAUL","687|MINOT-BSMRCK-DCKNSN(WLSTN)","762|MISSOULA","686|MOBILE-PENSACOLA (FT WALT)","628|MONROE-EL DORADO","828|MONTEREY-SALINAS","698|MONTGOMERY-SELMA","570|MYRTLE BEACH-FLORENCE","659|NASHVILLE","622|NEW ORLEANS","501|NEW YORK","544|NORFOLK-PORTSMTH-NEWPT NWS","740|NORTH PLATTE","633|ODESSA-MIDLAND","650|OKLAHOMA CITY","652|OMAHA","534|ORLANDO-DAYTONA BCH-MELBRN","631|OTTUMWA-KIRKSVILLE","632|PADUCAH-CAPE GIRARD-HARSBG","804|PALM SPRINGS","656|PANAMA CITY","597|PARKERSBURG","675|PEORIA-BLOOMINGTON","504|PHILADELPHIA","753|PHOENIX (PRESCOTT)","508|PITTSBURGH","500|PORTLAND-AUBURN","820|PORTLAND, OR","552|PRESQUE ISLE","521|PROVIDENCE-NEW BEDFORD","717|QUINCY-HANNIBAL-KEOKUK","560|RALEIGH-DURHAM (FAYETVLLE)","764|RAPID CITY","811|RENO","556|RICHMOND-PETERSBURG","573|ROANOKE-LYNCHBURG","538|ROCHESTER, NY","611|ROCHESTR-MASON CITY-AUSTIN","610|ROCKFORD","862|SACRAMNTO-STKTON-MODESTO","576|SALISBURY","770|SALT LAKE CITY","661|SAN ANGELO","641|SAN ANTONIO","825|SAN DIEGO","807|SAN FRANCISCO-OAK-SAN JOSE","855|SANTABARBRA-SANMAR-SANLUOB","507|SAVANNAH","819|SEATTLE-TACOMA","657|SHERMAN-ADA","612|SHREVEPORT","624|SIOUX CITY","725|SIOUX FALLS(MITCHELL)","588|SOUTH BEND-ELKHART","881|SPOKANE","543|SPRINGFIELD-HOLYOKE","619|SPRINGFIELD, MO","638|ST. JOSEPH","609|ST. LOUIS","555|SYRACUSE","530|TALLAHASSEE-THOMASVILLE","539|TAMPA-ST. PETE (SARASOTA)","581|TERRE HAUTE","547|TOLEDO","605|TOPEKA","540|TRAVERSE CITY-CADILLAC","531|TRI-CITIES, TN-VA","789|TUCSON (SIERRA VISTA)","671|TULSA","760|TWIN FALLS","709|TYLER-LONGVIEW(LFKN&NCGD)","526|UTICA","626|VICTORIA","625|WACO-TEMPLE-BRYAN","511|WASHINGTON, DC (HAGRSTWN)","549|WATERTOWN","705|WAUSAU-RHINELANDER","548|WEST PALM BEACH-FT. PIERCE","554|WHEELING-STEUBENVILLE","627|WICHITA FALLS & LAWTON","678|WICHITA-HUTCHINSON PLUS","577|WILKES BARRE-SCRANTON-HZTN","550|WILMINGTON","810|YAKIMA-PASCO-RCHLND-KNNWCK","536|YOUNGSTOWN","771|YUMA-EL CENTRO","596|ZANESVILLE"];
var categories_dma_selected=["662|ABILENE-SWEETWATER","532|ALBANY-SCHENECTADY-TROY","525|ALBANY, GA","790|ALBUQUERQUE-SANTA FE","644|ALEXANDRIA, LA"];// distance category of chart
var categories_dma_selected_temp=[];// use when dma filter

//------------------------------ DMA Filter Dialog ----------------------------------
//Install DmaFilter Dialog
	var dmaFilterDialog=new contentDialog();
	//install dma list
	var dmaDialogContent=$('<div class="selectItemCss"><div class="title">DMA</div><div class="title" style="padding-left: 15px;">Selected DMA</div><div class="items"></div><div class="selected"></div></div>');
	function itemsDmaShow(){
		dmaDialogContent.find('.items').first().empty();
		$.each(dmaArray, function(index,item){
			var id=item.split("|")[0];
			var name=item.split("|")[1];
			var fistChart=name.substring(0,1);
			var lastChart=name.substring(1);
			var div=$('<button style="margin: 2px;text-transform: lowercase;width: 200px;text-align: left;" type="button" class="btn btn-default btn-xs"><span class="glyphicon glyphicon-plus"></span> <span style="font-size: 12pt;font-weight:bold;text-transform: uppercase;">'+fistChart+'</span>'+lastChart+'</button>');
			div.click(function(){
				categories_dma_selected_temp.push(item);
				$(this).remove();
				selectedDmaShow();
			});
			if(categories_dma_selected_temp.indexOf(item)<0){
				dmaDialogContent.find('.items').first().append(div);
			}			
		});	
		selectedDmaShow();
	}
	//function draw selected dma
	function selectedDmaShow(){
		dmaDialogContent.find('.selected').first().empty();
		$.each(categories_dma_selected_temp,function(index,item){
			var id=item.split("|")[0];
			var name=item.split("|")[1];
			var fistChart=name.substring(0,1);
			var lastChart=name.substring(1);
			var btn=$('<button style="margin: 2px;text-transform: lowercase;text-align: left;width: 200px;" type="button" class="btn btn-default btn-xs"> <span class="glyphicon glyphicon-remove"></span> <span style="font-size: 12pt;font-weight:bold;text-transform: uppercase;">'+fistChart+'</span>'+lastChart+'</button>');
			dmaDialogContent.find('.selected').first().append(btn);
			btn.click(function(){
				categories_dma_selected_temp.splice(categories_dma_selected_temp.indexOf(item),1);
				selectedDmaShow();
				itemsDmaShow();
			});
		});
	}
	
	dmaFilterDialog.setTitle("DMA Filter");
	dmaFilterDialog.setWidth(540);
	dmaFilterDialog.addDom(dmaDialogContent);
	//Clean list event
	dmaFilterDialog.addButton({
		name: 'Clear All',
		btnClass: 'btn-info',
		action: function(){
			categories_dma_selected_temp=[];
			itemsDmaShow();
			selectedDmaShow();
		}
	});
	//Apply new dma list event
	dmaFilterDialog.addButton({
		name: 'Apply',
		btnClass: 'btn-primary',
		action: function(){
			if(categories_dma_selected_temp.length==0){
				alert("Please select Dma!");
				return;
			}else{
				//copy categories dma from temp to selected
				categories_dma_selected=new Array();
				$.each(categories_dma_selected_temp, function(index,item){
					categories_dma_selected.push(item);
				});
			}
			
			dmaFilterDialog.hide();
			loadChartByDma();
		}
	});
	
	//Open dialog button
	$("#dmaFilterBtn").click(function(){
		dmaFilterDialog.open();	
		//copy categories dma to temp
		categories_dma_selected_temp=[];
		$.each(categories_dma_selected, function(index,item){
			categories_dma_selected_temp.push(item);
		});
		itemsDmaShow();
		selectedDmaShow();
	});
	//------------------------------ DMA Filter Dialog End----------------------------------
	
function loadChartByDma(){
	myDateRangeInput.disable();
	series_clicks=[];
	series_impressions=[];
	series_cta=[];
	var dateRange_value='where[date.between]='+urlMaster.getParam('where[date.between]');
	var measureValue=$("#e2").val();
	var url=apiRootUrl+'/AdvertiserByDma?select=date|dma|dma_name&limit=2000&'+dateRange_value+"&by=impressions|clicks|cta_anys";
	//add dma filter
	var dmaIdsQuery='&where[dma.in]=';
	p_dma_ids=[];
	$.each(categories_dma_selected, function(index,item){
		var id=item.split("|")[0];
		//push ids to array use when give param for jasper
		p_dma_ids.push(id);
		if(index>0){
			dmaIdsQuery+=",";
		}
		dmaIdsQuery+=id;
	});
	url+=dmaIdsQuery;
	
	//Send request to got data
	if(myAjaxStore.isLoading(url)){
		console.log('Your request is loading...');
		console.log('Callback after '+loadingCallback+'s...');
		delayTimeout(loadingCallback,function(){
			loadChartByDma();
		});
		return;
	}
	if(chart !=null){
		chart.showLoading();
	}

	var ajaxData=myAjaxStore.get(url);
	if(ajaxData==null){
		myAjaxStore.registe(url);
		$.ajax({
			dataType: "json",
			url: url,
			timeout: ajaxRequestTimeout,
			xhrFields: {
				      withCredentials: true
	   		},
			success: function(json){
				  myAjaxStore.add(url,json);
				  loadChartByDma();
			},
			error: function(xhr,status,error){
				myAjaxStore.remove(url);
				console.log('Request url error: '+url);
				console.log('Status:  '+status);
				console.log('Error:  '+error);
				console.log('Reload chart!');
				if(error=='timeout'){
					loadChartByDma();
				}else{
					delayTimeout(2000,function(){
						location.reload(false);
					});
				}
			},
			complete: function(){
				
			}
			});			
	}else{
		processData(ajaxData);
		if(ajaxData.data.length==0){
			var mydialog=new contentDialog();
			mydialog.setTitle("Daily Advertiser Message!");
			mydialog.setContent("Your data from "+selectStartDate.format('yyyy-mm-dd')+" to "+selectEndDate.format('yyyy-mm-dd')+" is not available.");
			mydialog.open();
		}
	}
	function processData(json){
		title="Advertiser Clicks By Date Dma";
	  	subtitle="From "+selectStartDate.format("yyyy-mm-dd")+" to "+selectEndDate.format("yyyy-mm-dd");
	  	var responseStatus=json.responseStatus;
	  	var page=json.page;
	  	if(responseStatus=='OK' && page==1){
	  		data=json.data;
	  		var name='';
	  		//this loop add date to series

	  		
	  		for(var i=0;i<data.length;i++){				  			
	  			var row=data[i];
	  			var newName=row[0];
	  			if(newName!=name){
	  				//console.log("Add serie: "+newName);
//			  		var initDataArray=[categories_distance.length];
//			  		var initDataArray2=[categories_distance.length];
//			  		var initDataArray3=[categories_distance.length];
//			  		for(var i=0; i<categories_distance.length;i++){
//			  			initDataArray[i]=0;
//			  			initDataArray2[i]=0;
//			  			initDataArray3[i]=0;
//			  		}
	  				var row={name: newName,data:[]};
	  				var row2={name: newName,data:[]};
	  				var row3={name: newName,data:[]};
	  				series_clicks.push(row);
	  				series_impressions.push(row2);
	  				series_cta.push(row3);
	  				name=newName;
	  			}

	  		}
	  		//end loop add date to series
	  		
	  		//begin add value
	  		for(var i=0;i<data.length;i++){
	  			var row=data[i];
	  			var newName=row[0];
	  			var dma=row[1]+'|'+row[2];
	  			var value=row[4];
	  			var value_imp=row[3];
	  			var value_cta=row[5];
	  			var index=categories_dma_selected.indexOf(dma);
	  			console.log("Add Value: "+newName+" ckl "+value+" im "+value_imp+" cta "+value_cta+ " index "+index +" dma "+dma);
	  			for(var j=0;j<series_clicks.length;j++){
		  			var item=series_clicks[j];	
		  			if(item.name==newName && index>=0){	
		  				console.log("Date "+newName+" "+j+" Add value "+ value+" At "+index);
		  				series_clicks[j].data[index]=parseFloat(value);
		  				series_impressions[j].data[index]=parseFloat(value_imp);
		  				series_cta[j].data[index]=parseFloat(value_cta);
		  			}
		  		}
	  		}
	  		//end add values
	  		
		  	//generate table data
		  	table_data=json.data;
		  	//end generate table data
		  	
		  	//generate table
		  	myTable=new drawTableFromArray({
		  		table_id: 'daily-advertiser-dataTable',
		  		table_colums: ['Date','Dma id','Dma name','Impressions','Clicks','Cta anys'],
		  		columns_format:['','','','number','number','number'],
		  		table_data: table_data,
		  		page_items: 25,
		  		paging: true,
		  		sort_by: 'Date',
		  		sortable: false,
		  		onClickRow: function(row){
		  			//alert(row[0]);
		  		}
		  	});
		  	
	  		
	  	}else{
	  		return;
	  	}
	  	// draw chart
	  	if(chart){
	  		chart.hideLoading();
	  	}
	  	categories_dma=[];
	  	$.each(categories_dma_selected,function(index,item){
	  		var name=item.split('|')[1];
	  		categories_dma.push(name);
	  	});
	  	drawChart(categories_dma,series_clicks,title,subtitle);
	  	  	
	  	//unable date range input
	  	myDateRangeInput.unable();		
	}
	
}