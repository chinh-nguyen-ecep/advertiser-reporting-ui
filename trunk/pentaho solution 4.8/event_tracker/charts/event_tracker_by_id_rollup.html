<html xmlns:xf="http://www.w3.org/2002/xforms">
<head>
<!-- do not include a <meta> tag -->
<link rel="stylesheet" type="text/css" href="/verve-lib/css/chartCommonScript.css"></link>
<script src="/verve-lib/scripts/jquery-1.7.1.min.js" type="text/javascript"></script>
<script src="/verve-lib/scripts/verve-script-jquery.js" type="text/javascript"></script>
<script src="/verve-lib/scripts/chartReportCommonScript.js" type="text/javascript"></script>
<title></title>
	
{xform-header}
</head>
<body class="pentaho">

	<div name="dialog-form" title="Control Panel" style="width: 460px;height: 520px;">	
		<form name="parameter-form" id="parameter-form" method="GET">
			<table class="tableForm">
			<tbody>
				<tr style="display:none">
					<th>Report type:</th>
					<td><div style="float: left;">{p_report_type}</div>
					</td>
				</tr>
				<tr>
					<th>Date mode:</th>
					<td><div style="float: left;">{p_date_mode}</div>
					</td>
				</tr>
				 <tr>
					 <th>Range from:</th>
					 <td><div name="datemode" style="float: left;">
						 <label style="margin-left: 0px;"></label> {p_start_date}
						 <label style="margin-left: 0px;">To:</label> {p_end_date}
						 </div>
						 <div name="monthmode" style="display: none;float: left;">
						 <label style="margin-left: 0px;"></label> {p_start_month}
						 <label style="margin-left: 0px;">To:</label> {p_end_month}
						 </div>
					</td>
				 </tr>
				<tr id="tr_to_add" style="display:none">
					<th>Measures:</th>
					<td>
						<div style="width: 300px;border: 1px solid gray">
						{p_measures} 
						</div>
					</td>
				</tr>
				<tr>
					<th>ID Filter:</th>
					<td>
					<input name="dimension_filter" type="text" class="dimension"/>
					<div name="dimension" class="dimension"></div>
					</td>
				</tr>
				<tr>
					<th>Event names:</th>
					<td>							
					<input name="dimension_filter2" type="text" class="dimension"/>
					<div name="dimension2" class="dimension"></div>
					</td>
				</tr>
				<tr id="tr_bt">
					<th>Chart type:</th>
					<td>{chart_type}</td>
				</tr>
			</tbody>
			</table>
		<div id="hide_in_form" style="display:none">
		{v_max_date}{v_min_date}
		{solution}
		{action}
		{path}
		</div> 
		</form>
    </div>    

	
	 
	<script> <![CDATA[	
	$(document).ready(function(){
				initChartPageTemplate({
					controlPanle_width: 460,
					//controlPanle_height: 530,
					generateFormContent: generateFormContent,
					formValidation:formValidation,
					doWhenOpenControlPanel: whenOpen,
					reportName:'Event Tracker by ID Rollup'
				});
	}); 

	//private function
	var generateFormContent= function(domContentForm,completedFn){		
		var form=domContentForm.children('form');
		var firstRun=true;
		//remove all choose option
		form.find('option[value=]').remove();
		var max_date=form.find('select[name=v_max_date] option:first-child').attr('value');
		var min_date=form.find('select[name=v_min_date] option:first-child').attr('value');
		var arrayDate=max_date.split('-');
		var myDate=new Date(arrayDate[0],(arrayDate[1]/1)-1,arrayDate[2]/1);
		var date = myDate;
		date.setDate(date.getDate()-6);
		var previous_date=parseDate(date);
		
		//Get date dom
		var input_start_date=form.find('[input[name=p_start_date]');
		input_start_date.removeAttr('id');
		//var new_ID=domContentForm.attr('name')+'_'+input_start_date.attr('id');
		//input_start_date.attr('id',new_ID);
		var input_end_date=form.find('[input[name=p_end_date]');
		input_end_date.removeAttr('id');
		//var new_ID=domContentForm.attr('name')+'_'+input_end_date.attr('id');
		//input_end_date.attr('id',new_ID);
		
		//create calendar
		input_start_date.attr('value',previous_date);
		input_start_date.datepicker({
			defaultDate: previous_date,
			dateFormat: 'yy-mm-dd',
			regional: ["en-GB"],
			maxDate: max_date,
			minDate: min_date,
			onSelect: function(dateText, inst) { 
				input_end_date.datepicker( "option", "minDate", dateText );
			}
		});
		//create calendar end date
		input_end_date.attr('value',max_date);
		input_end_date.datepicker({
			defaultDate: max_date,
			dateFormat: 'yy-mm-dd',
			regional: ["en-GB"],
			maxDate: max_date,
			minDate: min_date,
			onSelect: function(dateText, inst) { 
				input_start_date.datepicker( "option", "maxDate", dateText );
			}
		});
		//change mode
		form.find('input:radio[name=p_date_mode]').click(function(){
			var value=$(this).attr('value');
			if(value=='date'){
				form.find('div[name=datemode]').show();
				form.find('div[name=monthmode]').hide();			
			}else{
				form.find('div[name=datemode]').hide();
				form.find('div[name=monthmode]').show();			
			}

		});
	}
	
	var formValidation=function(domContentForm){
		var form=domContentForm.children('form');
		var validate=true;					
		//check select ID
		var dimesion=form.find('div[name=dimension] input:checked');
		if(dimesion.length==0){
			alert('Please select ID!');
			return false;
		}
		//check select Event
		var dimesion=form.find('div[name=dimension2] input:checked');
		if(dimesion.length==0){
			alert('Please select Event!');
			return false;
		}		
		//Compares start date and end date.
		var start_date_array=form.find('input[name=p_start_date]').attr('value').split("-");
		var end_date_array=form.find('input[name=p_end_date]').attr('value').split("-");
		var start_date=new Date();
		start_date.setFullYear(start_date_array[0],start_date_array[1]-1,start_date_array[2]);
		var end_date=new Date();
		end_date.setFullYear(end_date_array[0],end_date_array[1]-1,end_date_array[2]);
		
		if(start_date>end_date){
			alert('please choose start date < end date');
			return false;
		};
		return validate;
	}
	
	var whenOpen=function(domContentForm){
		var firstRun=true;
		var form=domContentForm.children('form');
		var divResult_id=form.find('div[name=dimension]');
		var box_filter_id=form.find('input[name=dimension_filter]');
		
		var divResult_event=form.find('div[name=dimension2]');
		var box_filter_event=form.find('input[name=dimension_filter2]');
		//load event function
		var loadEvent=function(){
			var publisher_id=checkBoxSelected2({
				checkBoxDom:divResult_id,
				checkBoxName:'p_flight_id'
			});
			var start_date=form.find('input[name=p_start_date]').attr('value');
			var end_date=form.find('input[name=p_end_date]').attr('value');
			var condition= 'is_active=true';
			
			if(publisher_id!='All Flight ID'){
				condition+= ' AND full_date BETWEEN \''+start_date+'\' AND \''+end_date+'\'';
				condition+= ' AND flight_id IN (SELECT UNNEST(STRING_TO_ARRAY(\''+publisher_id+'\', \''+','+'\')))';
			}else{
				condition+= ' AND full_date BETWEEN \''+start_date+'\' AND \''+end_date+'\'';
			}
			//alert(condition);
			//return;
			if(publisher_id==''){
				return;
			}
			loadParam({
				text:'Loading IDs',
				p_table:'evttracker.daily_event_stats',
				p_value_field:'event_name',
				p_name_field:'event_name',
				p_condition:condition,
				p_all_name:'All Event Names',
				p_all_value:'All Event Names', //default 0
				p_prompt_stype:'Scrolling Check List', //pulldown or Scrolling Check List
				p_param_name:'p_event_name',
				dom_content_result:divResult_event,
				success: function(){
						createFillter({
							box_filter:box_filter_event,
							check_box_list:divResult_event,
							fillter_by:'name',//option name,title,value
							select_type:''//option check_all,single_mode or null
						});						
				}
			});				
		
		}
	
		//load ID function
		var loadIDs=function(){
			loadParam({
				text:'Loading IDs',
				p_table:'evttracker.daily_event_stats',
				p_value_field:'flight_id',
				p_name_field:'flight_id',
				p_condition:'is_active=true',
				p_all_name:'All Flight ID',
				p_all_value:'All Flight ID', //default 0
				p_prompt_stype:'Scrolling Check List', //pulldown or Scrolling Check List
				p_param_name:'p_flight_id',
				dom_content_result:divResult_id,
				success: function(){
						createFillter({
							box_filter:box_filter_id,
							check_box_list:divResult_id,
							fillter_by:'name',//option name,title,value
							select_type:''//option check_all,single_mode or null
						});	
					$('input[name=p_flight_id]').change(function(){
						delay_timeout(1000,function(){
							loadEvent();
						});						
					});
					if(firstRun==true){
						loadEvent();
					}
					firstRun=false;
				}
			});			
		}
		
		var isEmpty=divResult_id.is(':empty');
		if(isEmpty){
			loadIDs();
		}else{
		
		}
		
	}
	




        ]]>
	</script>
</body>
     
</html>