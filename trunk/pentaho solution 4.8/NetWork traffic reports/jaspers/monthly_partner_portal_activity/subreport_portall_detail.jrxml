<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="subreport_portall_detail" pageWidth="555" pageHeight="802" columnWidth="535" leftMargin="0" rightMargin="0" topMargin="0" bottomMargin="0">
	<subDataset name="datasetPortal">
		<parameter name="calendar_year_month" class="java.lang.String">
			<defaultValueExpression><![CDATA[new String("1")]]></defaultValueExpression>
		</parameter>
		<parameter name="partner_id" class="java.lang.Integer">
			<defaultValueExpression><![CDATA[new Integer("1")]]></defaultValueExpression>
		</parameter>
		<parameter name="portal_id" class="java.lang.Integer">
			<defaultValueExpression><![CDATA[new Integer("1")]]></defaultValueExpression>
		</parameter>
		<parameter name="total_unique_views" class="java.lang.Long">
			<defaultValueExpression><![CDATA[new Long("1")]]></defaultValueExpression>
		</parameter>
		<parameter name="total_visit_views" class="java.lang.Long">
			<defaultValueExpression><![CDATA[new Long("1")]]></defaultValueExpression>
		</parameter>
		<parameter name="total_page_views" class="java.lang.Long">
			<defaultValueExpression><![CDATA[new Long("1")]]></defaultValueExpression>
		</parameter>
		<queryString>
			<![CDATA[Select *
from
(
SELECT
     a."calendar_year_month",
     a."parent1_name" AS group_name,
     a."parent1_id" AS group_id,
     a."parent1_name" || ' (' || a."parent1_id"::text || ')' as unique_group_name,
     a."partner_name",
     a."partner_id" ,
     a."partner_name" || ' (' || a."partner_id"::text || ')' as unique_partner_name,
     a."portal_name" ,
     a."portal_id"  ,
     a."portal_name" || ' (' || a."portal_id"::text || ')' as unique_portal_name,
     COALESCE(a."unique_views",0) as unique_views,
     COALESCE(a."visits",0) as visits,
     COALESCE(a."page_views",0) as page_views,
    (a."dt_lastchange"::timestamp 
	with time zone AT TIME ZONE 'America/Los_Angeles')::timestamp 
	with time zone AT TIME ZONE 'America/New_York' as dt_lastchange
FROM
     "dw"."monthly_agg_site_traffic" a
WHERE
     a.calendar_year_month = $P{calendar_year_month}::text
 AND a.partner_id = $P{partner_id}::int
 AND a.portal_id = $P{portal_id}::int
 AND a.is_active = true
 union
 SELECT
     a."calendar_year_month",
     a."parent1_name" AS group_name,
     a."parent1_id" AS group_id,
     a."parent1_name" || ' (' || a."parent1_id"::text || ')' as unique_group_name,
     a."partner_name",
     a."partner_id" ,
     a."partner_name" || ' (' || a."partner_id"::text || ')' as unique_partner_name,
     a."portal_name" ,
     a."portal_id"  ,
     a."portal_name" || ' (' || a."portal_id"::text || ')' as unique_portal_name,
     COALESCE(a."unique_views",0) as unique_views,
     COALESCE(a."visits",0) as visits,
     COALESCE(a."page_views",0) as page_views,
    (a."dt_lastchange"::timestamp 
	with time zone AT TIME ZONE 'America/Los_Angeles')::timestamp 
	with time zone AT TIME ZONE 'America/New_York' as dt_lastchange
FROM
     "dw"."monthly_agg_site_traffic" a
     inner join (select distinct portal_id from "dw"."monthly_agg_site_traffic" where calendar_year_month = $P{calendar_year_month}::text AND partner_id = $P{partner_id}::int and $P{portal_id}::int = -1) b on a.portal_id = b.portal_id
WHERE
     a.calendar_year_month = $P{calendar_year_month}::text
 AND a.partner_id = $P{partner_id}::int
 AND a.is_active = true
 ) aa
 order by page_views desc]]>
		</queryString>
		<field name="calendar_year_month" class="java.lang.String">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="group_name" class="java.lang.String">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="group_id" class="java.lang.Integer">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="unique_group_name" class="java.lang.String">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="partner_name" class="java.lang.String">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="partner_id" class="java.lang.Integer">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="unique_partner_name" class="java.lang.String">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="portal_name" class="java.lang.String">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="portal_id" class="java.lang.Integer">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="unique_portal_name" class="java.lang.String">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="unique_views" class="java.lang.Integer">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="visits" class="java.lang.Integer">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="page_views" class="java.lang.Integer">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="dt_lastchange" class="java.sql.Timestamp">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
	</subDataset>
	<parameter name="calendar_year_month" class="java.lang.String">
		<defaultValueExpression><![CDATA[new String("1")]]></defaultValueExpression>
	</parameter>
	<parameter name="partner_id" class="java.lang.Integer">
		<defaultValueExpression><![CDATA[new Integer("1")]]></defaultValueExpression>
	</parameter>
	<parameter name="portal_id" class="java.lang.Integer">
		<defaultValueExpression><![CDATA[new Integer("1")]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[Select *
from
(
SELECT
     a."calendar_year_month",
     a."parent1_name" AS group_name,
     a."parent1_id" AS group_id,
     a."partner_name",
     a."partner_id" ,
     sum(a."unique_views") as total_unique_views,
     sum(a."visits")  as total_visit_views,
     sum(a."page_views") as total_page_views
FROM
     "dw"."monthly_agg_site_traffic" a
WHERE
     a.calendar_year_month = $P{calendar_year_month}::text
 AND a.partner_id = $P{partner_id}::int
 AND a.portal_id = $P{portal_id}::int
 AND a.is_active = true
GROUP BY calendar_year_month,group_name,group_id,partner_name,partner_id
 union
 SELECT
     a."calendar_year_month",
     a."parent1_name" AS group_name,
     a."parent1_id" AS group_id,
     a."partner_name",
     a."partner_id" ,
     sum(a."unique_views") as total_unique_views,
     sum(a."visits")  as total_visit_views,
     sum(a."page_views") as total_page_views
FROM
     "dw"."monthly_agg_site_traffic" a
     inner join (select distinct portal_id from "dw"."monthly_agg_site_traffic" where calendar_year_month = $P{calendar_year_month}::text AND partner_id = $P{partner_id}::int and $P{portal_id}::int = -1) b on a.portal_id = b.portal_id
WHERE
     a.calendar_year_month = $P{calendar_year_month}::text
 AND a.partner_id = $P{partner_id}::int
 AND a.is_active = true
GROUP BY calendar_year_month,group_name,group_id,partner_name,partner_id
 ) aa
 order by total_page_views desc]]>
	</queryString>
	<field name="calendar_year_month" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="group_name" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="group_id" class="java.lang.Integer">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="partner_name" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="partner_id" class="java.lang.Integer">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="total_unique_views" class="java.lang.Long">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="total_visit_views" class="java.lang.Long">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="total_page_views" class="java.lang.Long">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<background>
		<band/>
	</background>
	<summary>
		<band height="760">
			<pieChart>
				<chart>
					<reportElement x="0" y="0" width="555" height="250"/>
					<chartTitle>
						<font fontName="Arial" size="12" isBold="true"/>
						<titleExpression><![CDATA["Unique Views"]]></titleExpression>
					</chartTitle>
					<chartSubtitle>
						<font fontName="Arial" size="8"/>
					</chartSubtitle>
					<chartLegend position="Right">
						<font fontName="Arial" size="8"/>
					</chartLegend>
				</chart>
				<pieDataset>
					<dataset>
						<datasetRun subDataset="datasetPortal">
							<datasetParameter name="calendar_year_month">
								<datasetParameterExpression><![CDATA[$P{calendar_year_month}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="partner_id">
								<datasetParameterExpression><![CDATA[$P{partner_id}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="portal_id">
								<datasetParameterExpression><![CDATA[$P{portal_id}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="total_unique_views">
								<datasetParameterExpression><![CDATA[$F{total_unique_views}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="total_visit_views">
								<datasetParameterExpression><![CDATA[$F{total_visit_views}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="total_page_views">
								<datasetParameterExpression><![CDATA[$F{total_page_views}]]></datasetParameterExpression>
							</datasetParameter>
							<connectionExpression><![CDATA[$P{REPORT_CONNECTION}]]></connectionExpression>
						</datasetRun>
					</dataset>
					<keyExpression><![CDATA[$F{unique_portal_name}]]></keyExpression>
					<valueExpression><![CDATA[$F{unique_views}]]></valueExpression>
					<labelExpression><![CDATA[new DecimalFormat("0.00").format(new Double(($F{unique_views}.doubleValue()*100)/$P{total_unique_views}.doubleValue())) + "%"]]></labelExpression>
					<sectionHyperlink/>
				</pieDataset>
				<piePlot>
					<plot/>
				</piePlot>
			</pieChart>
			<pieChart>
				<chart>
					<reportElement positionType="Float" x="0" y="255" width="555" height="250"/>
					<chartTitle>
						<font fontName="Arial" size="12" isBold="true"/>
						<titleExpression><![CDATA["Page Views"]]></titleExpression>
					</chartTitle>
					<chartSubtitle>
						<font fontName="Arial" size="8"/>
					</chartSubtitle>
					<chartLegend position="Right">
						<font fontName="Arial" size="8"/>
					</chartLegend>
				</chart>
				<pieDataset>
					<dataset>
						<datasetRun subDataset="datasetPortal">
							<datasetParameter name="calendar_year_month">
								<datasetParameterExpression><![CDATA[$P{calendar_year_month}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="partner_id">
								<datasetParameterExpression><![CDATA[$P{partner_id}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="portal_id">
								<datasetParameterExpression><![CDATA[$P{portal_id}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="total_unique_views">
								<datasetParameterExpression><![CDATA[$F{total_unique_views}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="total_visit_views">
								<datasetParameterExpression><![CDATA[$F{total_visit_views}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="total_page_views">
								<datasetParameterExpression><![CDATA[$F{total_page_views}]]></datasetParameterExpression>
							</datasetParameter>
							<connectionExpression><![CDATA[$P{REPORT_CONNECTION}]]></connectionExpression>
						</datasetRun>
					</dataset>
					<keyExpression><![CDATA[$F{unique_portal_name}]]></keyExpression>
					<valueExpression><![CDATA[$F{page_views}]]></valueExpression>
					<labelExpression><![CDATA[new DecimalFormat("0.00").format(new Double(($F{page_views}.doubleValue()*100)/$P{total_page_views}.doubleValue())) + "%"]]></labelExpression>
					<sectionHyperlink/>
				</pieDataset>
				<piePlot>
					<plot/>
				</piePlot>
			</pieChart>
			<pieChart>
				<chart>
					<reportElement positionType="Float" x="0" y="510" width="555" height="250"/>
					<chartTitle>
						<font fontName="Arial" size="12" isBold="true"/>
						<titleExpression><![CDATA["Visit Views"]]></titleExpression>
					</chartTitle>
					<chartSubtitle>
						<font fontName="Arial" size="8"/>
					</chartSubtitle>
					<chartLegend position="Right">
						<font fontName="Arial" size="8"/>
					</chartLegend>
				</chart>
				<pieDataset>
					<dataset>
						<datasetRun subDataset="datasetPortal">
							<datasetParameter name="calendar_year_month">
								<datasetParameterExpression><![CDATA[$P{calendar_year_month}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="partner_id">
								<datasetParameterExpression><![CDATA[$P{partner_id}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="portal_id">
								<datasetParameterExpression><![CDATA[$P{portal_id}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="total_unique_views">
								<datasetParameterExpression><![CDATA[$F{total_unique_views}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="total_visit_views">
								<datasetParameterExpression><![CDATA[$F{total_visit_views}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="total_page_views">
								<datasetParameterExpression><![CDATA[$F{total_page_views}]]></datasetParameterExpression>
							</datasetParameter>
							<connectionExpression><![CDATA[$P{REPORT_CONNECTION}]]></connectionExpression>
						</datasetRun>
					</dataset>
					<keyExpression><![CDATA[$F{unique_portal_name}]]></keyExpression>
					<valueExpression><![CDATA[$F{visits}]]></valueExpression>
					<labelExpression><![CDATA[new DecimalFormat("0.00").format(new Double(($F{visits}.doubleValue()*100)/$P{total_visit_views}.doubleValue())) + "%"]]></labelExpression>
					<sectionHyperlink/>
				</pieDataset>
				<piePlot>
					<plot/>
				</piePlot>
			</pieChart>
		</band>
	</summary>
</jasperReport>
