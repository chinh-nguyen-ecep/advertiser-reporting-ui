<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="subreport_portal_detail" pageWidth="555" pageHeight="800" columnWidth="535" leftMargin="0" rightMargin="0" topMargin="0" bottomMargin="0">
	<subDataset name="dataset1">
		<parameter name="eastern_date_sk" class="java.lang.Integer">
			<defaultValueExpression><![CDATA[]]></defaultValueExpression>
		</parameter>
		<parameter name="partner_id" class="java.lang.Integer">
			<defaultValueExpression><![CDATA[]]></defaultValueExpression>
		</parameter>
		<parameter name="portal_id" class="java.lang.Integer">
			<defaultValueExpression><![CDATA[]]></defaultValueExpression>
		</parameter>
		<parameter name="total_unique_views" class="java.lang.Long"/>
		<parameter name="total_page_views" class="java.lang.Long"/>
		<parameter name="total_visit_views" class="java.lang.Long"/>
		<queryString>
			<![CDATA[SELECT
     a."eastern_date_sk",
     a."full_date",
     a."parent1_name" AS group_name,
     a."parent1_id" AS group_id,
     a."parent1_name"||' ('||a."parent1_id"::text||')'as unique_group_name,
     a."partner_name",
     a."partner_id",
     a."partner_name"||' ('||a."partner_id"::text||')'as unique_partner_name,
     a."portal_name",
     a."portal_id",
     a."portal_name"||' ('||a."portal_id"::text||')'as unique_portal_name,
     a."unique_views",
     a."visits",
     a."page_views",
     (a."dt_lastchange"::timestamp with time zone AT TIME ZONE 'America/Los_Angeles')::timestamp with time zone AT TIME ZONE 'America/New_York'as dt_lastchange
FROM
     "dw"."daily_agg_site_traffic" a
WHERE
     a.eastern_date_sk = $P{eastern_date_sk}::int
 AND a.partner_id = $P{partner_id}::int
 AND a.portal_id = $P{portal_id}::int
 AND a.is_active = true
UNION
SELECT
     a."eastern_date_sk",
     a."full_date",
     a."parent1_name" AS group_name,
     a."parent1_id" AS group_id,
     a."parent1_name"||' ('||a."parent1_id"::text||')'as unique_group_name,
     a."partner_name",
     a."partner_id",
     a."partner_name"||' ('||a."partner_id"::text||')'as unique_partner_name,
     a."portal_name",
     a."portal_id",
     a."portal_name"||' ('||a."portal_id"::text||')'as unique_portal_name,
     a."unique_views",
     a."visits",
     a."page_views",
     (a."dt_lastchange"::timestamp with time zone AT TIME ZONE 'America/Los_Angeles')::timestamp with time zone AT TIME ZONE 'America/New_York'as dt_lastchange
FROM
     "dw"."daily_agg_site_traffic" a 
     inner join (select portal_id from "dw"."daily_agg_site_traffic" where eastern_date_sk = $P{eastern_date_sk}::int AND partner_id = $P{partner_id}::int and $P{portal_id} = -1) b on a.portal_id = b.portal_id
WHERE
     a.eastern_date_sk = $P{eastern_date_sk}::int
 AND a.partner_id = $P{partner_id}::int
 AND a.is_active = true
ORDER BY page_views desc]]>
		</queryString>
		<field name="eastern_date_sk" class="java.lang.Integer">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="full_date" class="java.sql.Date">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="group_name" class="java.lang.String">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="group_id" class="java.lang.Integer">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="unique_group_name" class="java.lang.String">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="partner_name" class="java.lang.String">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="partner_id" class="java.lang.Integer">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="unique_partner_name" class="java.lang.String">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="portal_name" class="java.lang.String">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="portal_id" class="java.lang.Integer">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="unique_portal_name" class="java.lang.String">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="unique_views" class="java.lang.Integer">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="visits" class="java.lang.Integer">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="page_views" class="java.lang.Integer">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
		<field name="dt_lastchange" class="java.sql.Timestamp">
			<fieldDescription><![CDATA[]]></fieldDescription>
		</field>
	</subDataset>
	<parameter name="eastern_date_sk" class="java.lang.Integer">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="partner_id" class="java.lang.Integer">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="portal_id" class="java.lang.Integer">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[SELECT
     a."eastern_date_sk",
     a."full_date",
     a."parent1_name" AS group_name,
     a."parent1_id" AS group_id,
     a."parent1_name"||' ('||a."parent1_id"::text||')'as unique_group_name,
     a."partner_name",
     a."partner_id",
     a."partner_name"||' ('||a."partner_id"::text||')'as unique_partner_name,
     sum(a."unique_views") as total_unique_views,
     sum(a."visits") as total_visits,
     sum(a."page_views") as total_page_views
FROM
     "dw"."daily_agg_site_traffic" a
WHERE
     a.eastern_date_sk = $P{eastern_date_sk}::int
 AND a.partner_id = $P{partner_id}::int
 AND a.portal_id = $P{portal_id}::int
 AND a.is_active = true
 GROUP BY eastern_date_sk,full_date,group_name,group_id,unique_group_name,partner_name,partner_id
UNION
SELECT
     a."eastern_date_sk",
     a."full_date",
     a."parent1_name" AS group_name,
     a."parent1_id" AS group_id,
     a."parent1_name"||' ('||a."parent1_id"::text||')'as unique_group_name,
     a."partner_name",
     a."partner_id",
     a."partner_name"||' ('||a."partner_id"::text||')'as unique_partner_name,
     sum(a."unique_views") as total_unique_views,
     sum(a."visits") as total_visits,
     sum(a."page_views") as total_page_views
FROM
     "dw"."daily_agg_site_traffic" a 
     inner join (select portal_id from "dw"."daily_agg_site_traffic" where eastern_date_sk = $P{eastern_date_sk}::int AND partner_id = $P{partner_id}::int and $P{portal_id} = -1) b on a.portal_id = b.portal_id
WHERE
     a.eastern_date_sk = $P{eastern_date_sk}::int
 AND a.partner_id = $P{partner_id}::int
 AND a.is_active = true
 GROUP BY eastern_date_sk,full_date,group_name,group_id,unique_group_name,partner_name,partner_id]]>
	</queryString>
	<field name="eastern_date_sk" class="java.lang.Integer">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="full_date" class="java.sql.Date">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="group_name" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="group_id" class="java.lang.Integer">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="unique_group_name" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="partner_name" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="partner_id" class="java.lang.Integer">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="unique_partner_name" class="java.lang.String">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="total_unique_views" class="java.lang.Long">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="total_visits" class="java.lang.Long">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<field name="total_page_views" class="java.lang.Long">
		<fieldDescription><![CDATA[]]></fieldDescription>
	</field>
	<background>
		<band/>
	</background>
	<columnFooter>
		<band/>
	</columnFooter>
	<summary>
		<band height="750">
			<pieChart>
				<chart>
					<reportElement positionType="Float" x="0" y="0" width="555" height="250"/>
					<chartTitle>
						<font fontName="Arial" size="12" isBold="true"/>
						<titleExpression><![CDATA["Unique Views"]]></titleExpression>
					</chartTitle>
					<chartSubtitle>
						<font fontName="Arial" size="8"/>
					</chartSubtitle>
					<chartLegend position="Right">
						<font fontName="Arial" size="8"/>
					</chartLegend>
				</chart>
				<pieDataset>
					<dataset>
						<datasetRun subDataset="dataset1">
							<datasetParameter name="eastern_date_sk">
								<datasetParameterExpression><![CDATA[$P{eastern_date_sk}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="partner_id">
								<datasetParameterExpression><![CDATA[$P{partner_id}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="portal_id">
								<datasetParameterExpression><![CDATA[$P{portal_id}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="total_unique_views">
								<datasetParameterExpression><![CDATA[$F{total_unique_views}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="total_page_views">
								<datasetParameterExpression><![CDATA[$F{total_page_views}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="total_visit_views">
								<datasetParameterExpression><![CDATA[$F{total_visits}]]></datasetParameterExpression>
							</datasetParameter>
							<connectionExpression><![CDATA[$P{REPORT_CONNECTION}]]></connectionExpression>
						</datasetRun>
					</dataset>
					<keyExpression><![CDATA[$F{unique_portal_name}]]></keyExpression>
					<valueExpression><![CDATA[$F{unique_views}]]></valueExpression>
					<labelExpression><![CDATA[new DecimalFormat("0.00").format(new Double(($F{unique_views}.doubleValue()*100)/$P{total_unique_views}.doubleValue())) + "%"]]></labelExpression>
					<sectionHyperlink/>
				</pieDataset>
				<piePlot>
					<plot/>
				</piePlot>
			</pieChart>
			<pieChart>
				<chart>
					<reportElement positionType="Float" x="0" y="250" width="555" height="250"/>
					<chartTitle>
						<font fontName="Arial" size="12" isBold="true"/>
						<titleExpression><![CDATA["Page Views"]]></titleExpression>
					</chartTitle>
					<chartSubtitle>
						<font fontName="Arial" size="8"/>
					</chartSubtitle>
					<chartLegend position="Right">
						<font fontName="Arial" size="8"/>
					</chartLegend>
				</chart>
				<pieDataset>
					<dataset>
						<datasetRun subDataset="dataset1">
							<datasetParameter name="eastern_date_sk">
								<datasetParameterExpression><![CDATA[$P{eastern_date_sk}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="partner_id">
								<datasetParameterExpression><![CDATA[$P{partner_id}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="portal_id">
								<datasetParameterExpression><![CDATA[$P{portal_id}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="total_page_views">
								<datasetParameterExpression><![CDATA[$F{total_page_views}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="total_unique_views">
								<datasetParameterExpression><![CDATA[$F{total_unique_views}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="total_visit_views">
								<datasetParameterExpression><![CDATA[$F{total_visits}]]></datasetParameterExpression>
							</datasetParameter>
							<connectionExpression><![CDATA[$P{REPORT_CONNECTION}]]></connectionExpression>
						</datasetRun>
					</dataset>
					<keyExpression><![CDATA[$F{unique_portal_name}]]></keyExpression>
					<valueExpression><![CDATA[$F{page_views}]]></valueExpression>
					<labelExpression><![CDATA[new DecimalFormat("0.00").format(new Double(($F{page_views}.doubleValue()*100)/$P{total_page_views}.doubleValue())) + "%"]]></labelExpression>
					<sectionHyperlink/>
				</pieDataset>
				<piePlot>
					<plot/>
				</piePlot>
			</pieChart>
			<pieChart>
				<chart>
					<reportElement positionType="Float" x="0" y="500" width="555" height="250"/>
					<chartTitle>
						<font fontName="Arial" size="12" isBold="true"/>
						<titleExpression><![CDATA["Visit Views"]]></titleExpression>
					</chartTitle>
					<chartSubtitle>
						<font fontName="Arial" size="8"/>
					</chartSubtitle>
					<chartLegend position="Right">
						<font fontName="Arial" size="8"/>
					</chartLegend>
				</chart>
				<pieDataset>
					<dataset>
						<datasetRun subDataset="dataset1">
							<datasetParameter name="eastern_date_sk">
								<datasetParameterExpression><![CDATA[$P{eastern_date_sk}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="partner_id">
								<datasetParameterExpression><![CDATA[$P{partner_id}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="portal_id">
								<datasetParameterExpression><![CDATA[$P{portal_id}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="total_unique_views">
								<datasetParameterExpression><![CDATA[$F{total_unique_views}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="total_page_views">
								<datasetParameterExpression><![CDATA[$F{total_page_views}]]></datasetParameterExpression>
							</datasetParameter>
							<datasetParameter name="total_visit_views">
								<datasetParameterExpression><![CDATA[$F{total_visits}]]></datasetParameterExpression>
							</datasetParameter>
						</datasetRun>
					</dataset>
					<keyExpression><![CDATA[$F{unique_portal_name}]]></keyExpression>
					<valueExpression><![CDATA[$F{visits}]]></valueExpression>
					<labelExpression><![CDATA[new DecimalFormat("0.00").format(new Double(($F{visits}.doubleValue()*100)/$P{total_visit_views}.doubleValue())) + "%"]]></labelExpression>
					<sectionHyperlink/>
				</pieDataset>
				<piePlot>
					<plot/>
				</piePlot>
			</pieChart>
		</band>
	</summary>
</jasperReport>
