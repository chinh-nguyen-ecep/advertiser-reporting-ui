<html xmlns:xf="http://www.w3.org/2002/xforms">
<head>
<!-- do not include a <meta> tag -->
<link rel="stylesheet" type="text/css" href="/verve-lib/css/chartCommonScript.css"></link>
<script src="/verve-lib/scripts/jquery-1.7.1.min.js" type="text/javascript"></script>
<script src="/verve-lib/scripts/verve-script-jquery.js" type="text/javascript"></script>
<script src="/verve-lib/scripts/chartReportCommonScript.js" type="text/javascript"></script>
<title></title>
	
{xform-header}
</head>
<body class="pentaho">
	<div name="dialog-form" title="Control Panel" style="width: 460px;height: 520px;">	
         <form name="parameter-form" id="parameter-form" method="GET">
         <table class="tableForm">
         <tbody>
			<tr>
		         <th>Report type:</th>
		         <td><div style="float: left;">{p_report_type}</div>
		         </td>
	         </tr>
	         <tr>
		         <th>Date mode:</th>
		         <td><div style="float: left;">{p_date_mode}</div>
		         </td>
	         </tr>
	         <tr>
		         <th>Range from:</th>
		         <td><div name="datemode" style="float: left;">
		             <label style="margin-left: 0px;"></label> {p_start_date}
		             <label style="margin-left: 0px;">To:</label> {p_end_date}
		             </div>
		             <div name="monthmode" style="display: none;float: left;">
		             <label style="margin-left: 0px;"></label> {p_start_month}
		             <label style="margin-left: 0px;">To:</label> {p_end_month}
		             </div>
		        </td>
	         </tr>
	         <tr id="tr_to_add">
		         <th>Measures:</th>
		         <td>
				 <div name="p_measures" style="width: 300px;border: 1px solid gray">
		          {p_measures} 
				 </div>
		         </td>
	         </tr>
			<tr name="Publishers">
				<th>Publishers:</th>
				<td name="Publishers">

				</td>
			</tr>
			<tr name="Properties">
				<th>Properties:</th>
				<td>
				<input name="dimension_filter" type="text" class="dimension"/>
				<div name="dimension" class="dimension"></div>
				</td>
			</tr>
			<tr name="Placement">
				<th>Placement:</th>
				<td name="Placement">

				</td>
			</tr>
			<tr name="Creatives">
				<th>Creatives:</th>
				<td>
				<input name="dimension_filter2" type="text" class="dimension"/>
				<div name="dimension2" class="dimension"></div>
				</td>
			</tr>
			<tr id="tr_bt">
		         <th>Chart type:</th>
		         <td>{chart_type}</td>
	         </tr>
         </tbody>
         </table>
		<div id="hide_in_form" style="display:none">
		{v_max_date}{v_min_date}
		{solution}
		{action}
		{path}
		</div> 
	    </form>
      </div> <script> <![CDATA[	
	$(document).ready(function(){
				initChartPageTemplate({
					controlPanle_width: 460,
					//controlPanle_height: 530,
					generateFormContent: generateFormContent,
					formValidation:formValidation,
					doWhenOpenControlPanel: whenOpen,
					reportName:'Revenue Performance Chart'
				});
	}); 

	//private function
	var generateFormContent= function(domContentForm,completedFn){		
		var form=domContentForm.children('form');
		var firstRun=true;
		//remove all choose option
		form.find('option[value=]').remove();
		var max_date=form.find('select[name=v_max_date] option:first-child').attr('value');
		var min_date=form.find('select[name=v_min_date] option:first-child').attr('value');
		var arrayDate=max_date.split('-');
		var myDate=new Date(arrayDate[0],(arrayDate[1]/1)-1,arrayDate[2]/1);
		var date = myDate;
		date.setDate(date.getDate()-6);
		var previous_date=parseDate(date);
		
		//Get date dom
		var input_start_date=form.find('[input[name=p_start_date]');
		input_start_date.removeAttr('id');
		//var new_ID=domContentForm.attr('name')+'_'+input_start_date.attr('id');
		//input_start_date.attr('id',new_ID);
		var input_end_date=form.find('[input[name=p_end_date]');
		input_end_date.removeAttr('id');
		//var new_ID=domContentForm.attr('name')+'_'+input_end_date.attr('id');
		//input_end_date.attr('id',new_ID);
		
		//create calendar
		input_start_date.attr('value',previous_date);
		input_start_date.datepicker({
			defaultDate: previous_date,
			dateFormat: 'yy-mm-dd',
			regional: ["en-GB"],
			maxDate: max_date,
			minDate: min_date,
			onSelect: function(dateText, inst) { 
				input_end_date.datepicker( "option", "minDate", dateText );
				delay_timeout(1000,function(){
					var reportType=form.find('select[name=p_report_type]').attr('value');
					if(reportType=='Publisher Property report'){
						loadProperty(form);
					}else if(reportType=='Placement daily report'){
						loadCreative();
					}
				});
			},
			beforeShow: function( Element,Object){
				delay_timeout(100,function(){});
			}
		});
		//create calendar end date
		input_end_date.attr('value',max_date);
		input_end_date.datepicker({
			defaultDate: max_date,
			dateFormat: 'yy-mm-dd',
			regional: ["en-GB"],
			maxDate: max_date,
			minDate: min_date,
			onSelect: function(dateText, inst) { 
				input_start_date.datepicker( "option", "maxDate", dateText );
				delay_timeout(1000,function(){
					var reportType=form.find('select[name=p_report_type]').attr('value');
					if(reportType=='Publisher Property report'){
						loadProperty(form);
					}else if(reportType=='Placement daily report'){
						loadCreative();
					}
				});
			},
			beforeShow: function( Element,Object){
				delay_timeout(100,function(){});
			}
		});
		//Change month mode
		form.find('input[name=p_date_mode]').click(function(){
			var value=$(this).attr('value');
			if(value=='date'){
				form.find('div[name=datemode]').show();
				form.find('div[name=monthmode]').hide();
			}else{
				form.find('div[name=datemode]').hide();
				form.find('div[name=monthmode]').show();				
			}
		
		});
		//Set view for measure
		createFillter({
			box_filter:'',
			check_box_list:form.find('div[name=p_measures]'),
			fillter_by:'name',//option name,title,value
			select_type:''//option check_all,single_mode or null
		});
		//Change report type
		form.find('tr[name=Placement]').hide();
		form.find('tr[name=Creatives]').hide();	
		form.find('select[name=p_report_type]').change(function(){
			var chooseReport=$(this).attr('value');
			if(chooseReport=='Publisher Property report'){
				delay_timeout(1000,function(){
				form.find('div[name=dimension2]').empty();
				form.find('td[name=Placement]').empty();
				form.find('tr[name=Placement]').hide();
				form.find('tr[name=Creatives]').hide();	
				
				form.find('tr[name=Publishers]').show();
				form.find('tr[name=Properties]').show();
				loadPublisher(form,function(){loadProperty(form)});				
				});

			}else if(chooseReport=='Placement daily report'){
				delay_timeout(1000,function(){
					form.find('div[name=dimension]').empty();
					form.find('td[name=Publishers]').empty();
					form.find('tr[name=Publishers]').hide();
					form.find('tr[name=Properties]').hide();
					
					form.find('tr[name=Placement]').show();
					form.find('tr[name=Creatives]').show();	
					loadPlacement(form,function(){loadCreative(form)});
				});
			}
		});
	}
	
	var formValidation=function(domContentForm){
		var form=domContentForm.children('form');
		var validate=true;		
		var reportType=form.find('select[name=p_report_type]').attr('value');
		//check select ID
		var dimesion=form.find('div[name=dimension] input:checked');
		if(dimesion.length==0 && reportType=='Publisher Property report'){
			alert('Please select property!');
			return false;
		}	
		//Compares start date and end date.
		var start_date_array=form.find('input[name=p_start_date]').attr('value').split("-");
		var end_date_array=form.find('input[name=p_end_date]').attr('value').split("-");
		var start_date=new Date();
		start_date.setFullYear(start_date_array[0],start_date_array[1]-1,start_date_array[2]);
		var end_date=new Date();
		end_date.setFullYear(end_date_array[0],end_date_array[1]-1,end_date_array[2]);
		
		if(start_date>end_date){
			alert('please choose start date < end date');
			return false;
		};
		return validate;
	}
	
	var whenOpen=function(domContentForm){
		var firstRun=true;
		var form=domContentForm.children('form');
		var divResult_id=form.find('div[name=dimension]');
		var box_filter_id=form.find('input[name=dimension_filter]');			
		var isEmpty=divResult_id.is(':empty');
		if(isEmpty){
			loadPublisher(form,function(){loadProperty(form)});
		}else{
		
		}
		
	}
	
	//private function
	var loadPublisher=function(form,success){

			loadParam({
				text:'Loading Publishers',
				p_table:'adm.daily_agg_network_performance_min',
				p_value_field:'publisher_name',
				p_name_field:'publisher_name',
				p_condition:'is_active=true',
				p_all_name:'All Publishers',
				p_all_value:'All Publishers', //default 0
				p_prompt_stype:'pulldown', //pulldown or Scrolling Check List
				p_param_name:'p_Publisher',
				dom_content_result:form.find('td[name=Publishers]'),
				success: function(){
					form.find('select[name=p_Publisher]').change(function(){
						delay_timeout(1000,function(){
							loadProperty(form);
						});					
					});
					success();
				}
			});		
	}
	//load property function
	var loadProperty=function(form){
			var publisherValue=form.find('select[name=p_Publisher]').attr('value');
			var condition='is_active=true';
			var start_date=form.find('input[name=p_start_date]').attr('value');
			var end_date=form.find('input[name=p_start_date]').attr('value');
			condition+=' AND full_date BETWEEN \''+start_date+'\'::date AND \''+end_date+'\'::date';
			if(publisherValue!='All Publishers'){
				condition+=' AND publisher_name = \''+publisherValue+'\'';
			}
			loadParam({
				text:'Loading Properties',
				p_table:'adm.daily_agg_network_performance_min',
				p_value_field:'property_name',
				p_name_field:'property_name',
				p_condition:condition,
				p_all_name:'All Properties',
				p_all_value:'All Properties', //default 0
				p_prompt_stype:'Scrolling Check List', //pulldown or Scrolling Check List
				p_param_name:'p_Property',
				dom_content_result:form.find('div[name=dimension]'),
				success: function(){
						createFillter({
							box_filter:form.find('input[name=dimension_filter]'),
							check_box_list:form.find('div[name=dimension]'),
							fillter_by:'name',//option name,title,value
							select_type:''//option check_all,single_mode or null
						});
				}
			});		
	}
	
	//load Placement
	var loadPlacement=function(form,success){
			loadParam({
				text:'Loading Placements',
				p_table:'adm.daily_agg_network_performance_min',
				p_value_field:'placement_name',
				p_name_field:'placement_name',
				p_condition:'is_active=true',
				p_all_name:'All Placements',
				p_all_value:'All Placements', //default 0
				p_prompt_stype:'pulldown', //pulldown or Scrolling Check List
				p_param_name:'p_Placement',
				dom_content_result:form.find('td[name=Placement]'),
				success: function(){
					form.find('select[name=p_Placement]').change(function(){
						delay_timeout(1000,function(){
							
						});					
					});
					success();
				}
			});		
	}
	//load Creatives function
	var loadCreative=function(form){			
			var condition='is_active=true';
			var start_date=form.find('input[name=p_start_date]').attr('value');
			var end_date=form.find('input[name=p_start_date]').attr('value');
			condition+=' AND full_date BETWEEN \''+start_date+'\'::date AND \''+end_date+'\'::date';
			loadParam({
				text:'Loading Creatives',
				p_table:'adm.daily_agg_network_performance_min',
				p_value_field:'creative_name',
				p_name_field:'creative_name',
				p_condition:condition,
				p_all_name:'All Creatives',
				p_all_value:'All Creatives', //default 0
				p_prompt_stype:'Scrolling Check List', //pulldown or Scrolling Check List
				p_param_name:'p_Creative',
				dom_content_result:form.find('div[name=dimension2]'),
				success: function(){
						createFillter({
							box_filter:form.find('input[name=dimension_filter2]'),
							check_box_list:form.find('div[name=dimension2]'),
							fillter_by:'name',//option name,title,value
							select_type:''//option check_all,single_mode or null
						});
				}
			});		
	}
        ]]>
	</script>
   </body>
     
</html>