<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="local_revenue_summary_subreport1" language="groovy" pageWidth="1480" pageHeight="842" orientation="Landscape" columnWidth="1480" leftMargin="0" rightMargin="0" topMargin="0" bottomMargin="0">
	<property name="ireport.zoom" value="1.99650000000001"/>
	<property name="ireport.x" value="956"/>
	<property name="ireport.y" value="0"/>
	<parameter name="p_start_date_sk" class="java.lang.String">
		<defaultValueExpression><![CDATA[new String("0")]]></defaultValueExpression>
	</parameter>
	<parameter name="p_end_date_sk" class="java.lang.String">
		<defaultValueExpression><![CDATA[new String("0")]]></defaultValueExpression>
	</parameter>
	<parameter name="p_publisher_id_list" class="java.lang.String">
		<defaultValueExpression><![CDATA[new String("0")]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[SELECT
a.publisher_name
,a.publisher_id
,a.partner_id
,a.adm_order_id
,a.flight_id
,a.flight_metric
,a.adname
,a.adid
,a.booked_rate
,a.verve_rate
,a.booked_units
,a.verve_share
,a.delivered_units
,a.billable_units
,a.gross_revenue
,a.p_net_revenue
,a.v_net_revenue
,b.remaining_units
FROM
(SELECT
	b.company_name_current as publisher_name
	,a.publisher_id
	,a.partner_id
	,a.order_id as adm_order_id
	,a.flight_id
	,upper(a.flight_metric) as flight_metric
	,advertiser_name as adname
	,advertiser_id as adid
	,flight_rate as booked_rate
	,verve_rate as verve_rate
	,fl_booked_units as booked_units,
	--,(case when sum(gross_revenue)>0 then round(sum(v_net_revenue)::numeric,2)/sum(gross_revenue) else 0 end) as verve_share,
	(CASE WHEN a.channel_id=11 AND a.partner_id>0 THEN (100-c.rev_share_mobileweb_local) / 100
			WHEN a.channel_id<>11 AND a.partner_id>0 THEN (100 - c.rev_share_apps_local) / 100
			ELSE 0
			END
	) as verve_share,
	sum(delivered_units) as delivered_units,
	sum(billable_units) as billable_units,
	sum(gross_revenue) as gross_revenue,
		--sum(p_net_revenue) as p_net_revenue,
		(CASE WHEN a.channel_id=11 AND a.partner_id>0 THEN sum(gross_revenue)*c.rev_share_mobileweb_local / 100
			WHEN a.channel_id<>11 AND a.partner_id>0 THEN sum(gross_revenue)*c.rev_share_apps_local / 100
			ELSE 0
			END
		) as p_net_revenue,
		--sum(v_net_revenue) as v_net_revenue,
		(CASE WHEN a.channel_id=11 AND a.partner_id>0 THEN sum(gross_revenue)*(100-c.rev_share_mobileweb_local) / 100
			WHEN a.channel_id<>11 AND a.partner_id>0 THEN sum(gross_revenue)*(100 - c.rev_share_apps_local) / 100
			ELSE 0
			END
		) as v_net_revenue,
	max(eastern_date_sk) as max_date_sk
	FROM adm.ba_daily_flight a
	LEFT JOIN refer.adm_publisher_dim b ON b.dt_expire = '9999-12-31' AND b.publisher_id = a.publisher_id
	LEFT JOIN refer.revenue_share_dim c ON c.dt_expire = '9999-12-31' AND c.partner_id = a.partner_id AND c.is_active = 1
	WHERE a.eastern_date_sk BETWEEN $P{p_start_date_sk}::int AND $P{p_end_date_sk}::int
	AND a.delivered_units>0
	AND a.is_active=true
	AND (a.publisher_id IN (select unnest(string_to_array($P{p_publisher_id_list}, ';'))::int) OR '0'=$P{p_publisher_id_list})
	GROUP BY a.publisher_id,publisher_name,adname,advertiser_id,a.partner_id,a.channel_id,adm_order_id,a.flight_id,a.flight_metric,booked_rate,verve_rate,booked_units,c.rev_share_mobileweb_local,c.rev_share_apps_local
	HAVING
			round((CASE WHEN a.channel_id=11 AND a.partner_id>0 THEN (100-c.rev_share_mobileweb_local) / 100
			WHEN a.channel_id<>11 AND a.partner_id>0 THEN (100 -c.rev_share_apps_local) / 100
			ELSE 0
			END
			)::numeric,2)>0
		AND round((CASE WHEN a.channel_id=11 AND a.partner_id>0 THEN (100-c.rev_share_mobileweb_local) / 100
			WHEN a.channel_id<>11 AND a.partner_id>0 THEN (100 -c.rev_share_apps_local) / 100
			ELSE 0
			END
			)::numeric,2)<1
		AND sum(gross_revenue)>0
) a
LEFT JOIN
(
	SELECT eastern_date_sk,publisher_id,partner_id,order_id as adm_order_id,flight_id,SUM(remaining_units) as remaining_units
	FROM adm.ba_daily_flight a
	WHERE a.eastern_date_sk BETWEEN $P{p_start_date_sk}::int AND $P{p_end_date_sk}::int
	AND a.delivered_units>0
	AND a.is_active=true
	AND (a.publisher_id IN (select unnest(string_to_array($P{p_publisher_id_list}, ';'))::int) OR '0'=$P{p_publisher_id_list})
	GROUP BY eastern_date_sk,publisher_id,partner_id,adm_order_id,flight_id
)b ON b.eastern_date_sk=a.max_date_sk AND a.publisher_id=b.publisher_id AND a.partner_id=b.partner_id AND a.adm_order_id=b.adm_order_id AND a.flight_id=b.flight_id
ORDER BY a.publisher_name,a.adname,a.adm_order_id,a.flight_id]]>
	</queryString>
	<field name="publisher_name" class="java.lang.String"/>
	<field name="publisher_id" class="java.lang.Integer"/>
	<field name="partner_id" class="java.lang.Integer"/>
	<field name="adm_order_id" class="java.lang.Integer"/>
	<field name="flight_id" class="java.lang.Integer"/>
	<field name="flight_metric" class="java.lang.String"/>
	<field name="adname" class="java.lang.String"/>
	<field name="adid" class="java.lang.Integer"/>
	<field name="booked_rate" class="java.lang.Double"/>
	<field name="verve_rate" class="java.lang.Double"/>
	<field name="booked_units" class="java.lang.Double"/>
	<field name="verve_share" class="java.lang.Double"/>
	<field name="delivered_units" class="java.lang.Long"/>
	<field name="billable_units" class="java.lang.Long"/>
	<field name="gross_revenue" class="java.lang.Double"/>
	<field name="p_net_revenue" class="java.lang.Double"/>
	<field name="v_net_revenue" class="java.lang.Double"/>
	<field name="remaining_units" class="java.lang.Long"/>
	<variable name="total_gross_rev" class="java.lang.Double" calculation="Sum">
		<variableExpression><![CDATA[$F{gross_revenue}]]></variableExpression>
	</variable>
	<variable name="total_p_net_rev" class="java.lang.Double" calculation="Sum">
		<variableExpression><![CDATA[$F{p_net_revenue}]]></variableExpression>
	</variable>
	<variable name="total_v_net_rev" class="java.lang.Double" calculation="Sum">
		<variableExpression><![CDATA[$F{v_net_revenue}]]></variableExpression>
	</variable>
	<variable name="total_deliv_units" class="java.lang.Long" calculation="Sum">
		<variableExpression><![CDATA[$F{delivered_units}]]></variableExpression>
	</variable>
	<variable name="total_bill_units" class="java.lang.Long" calculation="Sum">
		<variableExpression><![CDATA[$F{billable_units}]]></variableExpression>
	</variable>
	<variable name="remaining_units_1" class="java.lang.Long" calculation="Sum">
		<variableExpression><![CDATA[$F{remaining_units}]]></variableExpression>
	</variable>
	<columnHeader>
		<band height="76" splitType="Stretch">
			<staticText>
				<reportElement x="0" y="0" width="260" height="38"/>
				<textElement verticalAlignment="Middle">
					<font fontName="Arial" size="12" isBold="true"/>
				</textElement>
				<text><![CDATA[Performance By Publishers by PartnerID:]]></text>
			</staticText>
			<staticText>
				<reportElement x="0" y="38" width="260" height="30"/>
				<textElement verticalAlignment="Top">
					<font fontName="Arial" isBold="true"/>
				</textElement>
				<text><![CDATA[Publisher]]></text>
			</staticText>
			<staticText>
				<reportElement x="520" y="38" width="80" height="30"/>
				<textElement verticalAlignment="Top">
					<font fontName="Arial" isBold="true"/>
				</textElement>
				<text><![CDATA[Verve Local Share %]]></text>
			</staticText>
			<staticText>
				<reportElement x="600" y="38" width="80" height="30"/>
				<textElement verticalAlignment="Top">
					<font fontName="Arial" isBold="true"/>
				</textElement>
				<text><![CDATA[Partner ID]]></text>
			</staticText>
			<staticText>
				<reportElement mode="Transparent" x="1320" y="38" width="80" height="30" forecolor="#000000" backcolor="#FFFFFF"/>
				<textElement textAlignment="Right" verticalAlignment="Top" rotation="None" lineSpacing="Single" markup="none">
					<font fontName="Arial" size="10" isBold="true" isItalic="false" isUnderline="false" isStrikeThrough="false" pdfFontName="Helvetica" pdfEncoding="Cp1252" isPdfEmbedded="false"/>
				</textElement>
				<text><![CDATA[Gross
Revenue]]></text>
			</staticText>
			<staticText>
				<reportElement x="680" y="38" width="80" height="30"/>
				<textElement verticalAlignment="Top">
					<font fontName="Arial" isBold="true"/>
				</textElement>
				<text><![CDATA[ADM
Order ID]]></text>
			</staticText>
			<staticText>
				<reportElement mode="Transparent" x="1400" y="38" width="80" height="30" forecolor="#000000" backcolor="#FFFFFF"/>
				<textElement textAlignment="Right" verticalAlignment="Top" rotation="None" lineSpacing="Single" markup="none">
					<font fontName="Arial" size="10" isBold="true" isItalic="false" isUnderline="false" isStrikeThrough="false" pdfFontName="Helvetica" pdfEncoding="Cp1252" isPdfEmbedded="false"/>
				</textElement>
				<text><![CDATA[Verve Net
Revenue]]></text>
			</staticText>
			<staticText>
				<reportElement x="760" y="38" width="80" height="30"/>
				<textElement verticalAlignment="Top">
					<font fontName="Arial" isBold="true"/>
				</textElement>
				<text><![CDATA[ADM
Flight ID]]></text>
			</staticText>
			<staticText>
				<reportElement x="840" y="38" width="80" height="30"/>
				<textElement verticalAlignment="Top">
					<font fontName="Arial" isBold="true"/>
				</textElement>
				<text><![CDATA[Flight Metric]]></text>
			</staticText>
			<staticText>
				<reportElement x="920" y="38" width="80" height="30"/>
				<textElement textAlignment="Right" verticalAlignment="Top">
					<font fontName="Arial" isBold="true"/>
				</textElement>
				<text><![CDATA[Booked
Rate]]></text>
			</staticText>
			<staticText>
				<reportElement x="1160" y="38" width="80" height="30"/>
				<textElement textAlignment="Right" verticalAlignment="Top">
					<font fontName="Arial" isBold="true"/>
				</textElement>
				<text><![CDATA[Billable
Units]]></text>
			</staticText>
			<staticText>
				<reportElement x="1080" y="38" width="80" height="30"/>
				<textElement textAlignment="Right" verticalAlignment="Top">
					<font fontName="Arial" isBold="true"/>
				</textElement>
				<text><![CDATA[Delivered
Units]]></text>
			</staticText>
			<staticText>
				<reportElement x="1000" y="38" width="80" height="30"/>
				<textElement textAlignment="Right" verticalAlignment="Top">
					<font fontName="Arial" isBold="true"/>
				</textElement>
				<text><![CDATA[Booked
Units]]></text>
			</staticText>
			<staticText>
				<reportElement x="1240" y="38" width="80" height="30"/>
				<textElement textAlignment="Right" verticalAlignment="Top">
					<font fontName="Arial" isBold="true"/>
				</textElement>
				<text><![CDATA[Remaining
Units]]></text>
			</staticText>
			<staticText>
				<reportElement x="260" y="38" width="260" height="30"/>
				<textElement verticalAlignment="Top">
					<font fontName="Arial" isBold="true"/>
				</textElement>
				<text><![CDATA[Advertiser Name]]></text>
			</staticText>
			<line>
				<reportElement x="0" y="68" width="1480" height="1"/>
			</line>
		</band>
	</columnHeader>
	<detail>
		<band height="20" splitType="Stretch">
			<textField>
				<reportElement x="0" y="0" width="260" height="20"/>
				<textElement>
					<font fontName="Arial"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{publisher_name}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="600" y="0" width="80" height="20"/>
				<textElement>
					<font fontName="Arial"/>
				</textElement>
				<textFieldExpression class="java.lang.Integer"><![CDATA[$F{partner_id}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="680" y="0" width="80" height="20"/>
				<textElement>
					<font fontName="Arial"/>
				</textElement>
				<textFieldExpression class="java.lang.Integer"><![CDATA[$F{adm_order_id}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="840" y="0" width="80" height="20"/>
				<textElement>
					<font fontName="Arial"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{flight_metric}]]></textFieldExpression>
			</textField>
			<textField pattern="$ #,##0.00" isBlankWhenNull="false">
				<reportElement mode="Transparent" x="920" y="0" width="80" height="20" forecolor="#000000" backcolor="#FFFFFF"/>
				<textElement textAlignment="Right" verticalAlignment="Top" rotation="None" lineSpacing="Single" markup="none">
					<font fontName="Arial" size="10" isBold="false" isItalic="false" isUnderline="false" isStrikeThrough="false" pdfFontName="Helvetica" pdfEncoding="Cp1252" isPdfEmbedded="false"/>
				</textElement>
				<textFieldExpression class="java.lang.Double"><![CDATA[$F{booked_rate}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0">
				<reportElement x="1080" y="0" width="80" height="20"/>
				<textElement textAlignment="Right">
					<font fontName="Arial"/>
				</textElement>
				<textFieldExpression class="java.lang.Long"><![CDATA[$F{delivered_units}]]></textFieldExpression>
			</textField>
			<textField pattern="$ #,##0.00">
				<reportElement x="1320" y="0" width="80" height="20"/>
				<textElement textAlignment="Right">
					<font fontName="Arial"/>
				</textElement>
				<textFieldExpression class="java.lang.Double"><![CDATA[$F{gross_revenue}]]></textFieldExpression>
			</textField>
			<textField pattern="$ #,##0.00">
				<reportElement x="1400" y="0" width="80" height="20"/>
				<textElement textAlignment="Right">
					<font fontName="Arial"/>
				</textElement>
				<textFieldExpression class="java.lang.Double"><![CDATA[$F{v_net_revenue}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0">
				<reportElement x="1160" y="0" width="80" height="20"/>
				<textElement textAlignment="Right">
					<font fontName="Arial"/>
				</textElement>
				<textFieldExpression class="java.lang.Long"><![CDATA[$F{billable_units}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0 %" isBlankWhenNull="false">
				<reportElement mode="Transparent" x="520" y="0" width="80" height="20" forecolor="#000000" backcolor="#FFFFFF"/>
				<textElement textAlignment="Left" verticalAlignment="Top" rotation="None" lineSpacing="Single" markup="none">
					<font fontName="Arial" size="10" isBold="false" isItalic="false" isUnderline="false" isStrikeThrough="false" pdfFontName="Helvetica" pdfEncoding="Cp1252" isPdfEmbedded="false"/>
				</textElement>
				<textFieldExpression class="java.lang.Double"><![CDATA[$F{verve_share}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0" isBlankWhenNull="false">
				<reportElement mode="Transparent" x="1000" y="0" width="80" height="20" forecolor="#000000" backcolor="#FFFFFF"/>
				<textElement textAlignment="Right" verticalAlignment="Top" rotation="None" lineSpacing="Single" markup="none">
					<font fontName="Arial" size="10" isBold="false" isItalic="false" isUnderline="false" isStrikeThrough="false" pdfFontName="Helvetica" pdfEncoding="Cp1252" isPdfEmbedded="false"/>
				</textElement>
				<textFieldExpression class="java.lang.Integer"><![CDATA[$F{booked_units}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0" isBlankWhenNull="false">
				<reportElement mode="Transparent" x="1240" y="0" width="80" height="20" forecolor="#000000" backcolor="#FFFFFF"/>
				<textElement textAlignment="Right" verticalAlignment="Top" rotation="None" lineSpacing="Single" markup="none">
					<font fontName="Arial" size="10" isBold="false" isItalic="false" isUnderline="false" isStrikeThrough="false" pdfFontName="Helvetica" pdfEncoding="Cp1252" isPdfEmbedded="false"/>
				</textElement>
				<textFieldExpression class="java.lang.Long"><![CDATA[$F{remaining_units}]]></textFieldExpression>
			</textField>
			<textField pattern="" isBlankWhenNull="false">
				<reportElement mode="Transparent" x="260" y="0" width="260" height="20" forecolor="#000000" backcolor="#FFFFFF"/>
				<textElement textAlignment="Left" verticalAlignment="Top" rotation="None" lineSpacing="Single" markup="none">
					<font fontName="Arial" size="10" isBold="false" isItalic="false" isUnderline="false" isStrikeThrough="false" pdfFontName="Helvetica" pdfEncoding="Cp1252" isPdfEmbedded="false"/>
				</textElement>
				<textFieldExpression class="java.lang.String"><![CDATA[$F{adname}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="760" y="0" width="80" height="20"/>
				<textElement>
					<font fontName="Arial"/>
				</textElement>
				<textFieldExpression class="java.lang.Integer"><![CDATA[$F{flight_id}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
	<summary>
		<band height="43">
			<textField pattern="$ #,##0.00">
				<reportElement x="1320" y="3" width="80" height="20"/>
				<textElement textAlignment="Right">
					<font fontName="Arial" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.Double"><![CDATA[$V{total_gross_rev}]]></textFieldExpression>
			</textField>
			<textField pattern="$ #,##0.00">
				<reportElement x="1400" y="3" width="80" height="20"/>
				<textElement textAlignment="Right">
					<font fontName="Arial" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.Double"><![CDATA[$V{total_v_net_rev}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0">
				<reportElement x="1080" y="3" width="80" height="20"/>
				<textElement textAlignment="Right">
					<font fontName="Arial" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.Long"><![CDATA[$V{total_deliv_units}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0">
				<reportElement x="1160" y="2" width="80" height="20"/>
				<textElement textAlignment="Right">
					<font fontName="Arial" isBold="true"/>
				</textElement>
				<textFieldExpression class="java.lang.Long"><![CDATA[$V{total_bill_units}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0" isBlankWhenNull="false">
				<reportElement mode="Transparent" x="1240" y="3" width="80" height="20" forecolor="#000000" backcolor="#FFFFFF"/>
				<textElement textAlignment="Right" verticalAlignment="Top" rotation="None" lineSpacing="Single" markup="none">
					<font fontName="Arial" size="10" isBold="true" isItalic="false" isUnderline="false" isStrikeThrough="false" pdfFontName="Helvetica" pdfEncoding="Cp1252" isPdfEmbedded="false"/>
				</textElement>
				<textFieldExpression class="java.lang.Long"><![CDATA[$V{remaining_units_1}]]></textFieldExpression>
			</textField>
			<line>
				<reportElement x="0" y="2" width="1480" height="1"/>
			</line>
		</band>
	</summary>
</jasperReport>
