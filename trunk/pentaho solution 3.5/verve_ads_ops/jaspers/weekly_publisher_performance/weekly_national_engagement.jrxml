<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="National Engagement Performance" pageWidth="5260" pageHeight="1684" orientation="Landscape" columnWidth="5220" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20">
	<property name="ireport.zoom" value="1.5"/>
	<property name="ireport.x" value="0"/>
	<property name="ireport.y" value="0"/>
	<style name="boder">
		<box leftPadding="5" rightPadding="5">
			<pen lineWidth="0.5"/>
			<topPen lineWidth="0.5"/>
			<leftPen lineWidth="0.5"/>
			<bottomPen lineWidth="0.5"/>
			<rightPen lineWidth="0.5"/>
		</box>
	</style>
	<parameter name="p_start_date_sk" class="java.lang.String">
		<defaultValueExpression><![CDATA[new String("0")]]></defaultValueExpression>
	</parameter>
	<parameter name="SUBREPORT_DIR" class="java.lang.String" isForPrompting="false">
		<defaultValueExpression><![CDATA[""]]></defaultValueExpression>
	</parameter>
	<parameter name="p_publisher_ids" class="java.lang.String">
		<defaultValueExpression><![CDATA[new String("0")]]></defaultValueExpression>
	</parameter>
	<parameter name="p_property_ids" class="java.lang.String">
		<defaultValueExpression><![CDATA[new String("0")]]></defaultValueExpression>
	</parameter>
	<parameter name="p_channel_ids" class="java.lang.String">
		<defaultValueExpression><![CDATA[new String("0")]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[SELECT year_week as "Week"
     , publisher_id as "Publisher ID"
     , publisher_name as "Publisher Name"
     , property_id as "Property ID"
     , property_name as "Property Name"
     , partner_keyword as "Partner Keyword"
     , channel_id as "Channel ID"
     , channel_name as "Channel Name"
     , ad_network_chain_id as "Chain ID"
     , ad_network_chain_name as "Chain Name"
     , SUM(adcel_requests_90) as "90days_Requests"
     , SUM(adcel_requests_30) as "30days_Requests"
     , SUM(adcel_requests_07) as "7days_Requests"
     , SUM(filled_requests_90) as "90days_Deliveries"
     , SUM(filled_requests_30) as "30days_Deliveries"
     , SUM(filled_requests_07) as "7days_Deliveries"
     , SUM(imp_cnt_90) as "90days_Impressions"
     , SUM(imp_cnt_30) as "30days_Impressions"
     , SUM(imp_cnt_07) as "7days_Impressions"
     , SUM(click_cnt_90) as "90days_Clicks"
     , SUM(click_cnt_30) as "30days_Clicks"
     , SUM(click_cnt_07) as "07days_Clicks"
     , SUM(cta_any_90) as "90days_cta_any"
     , SUM(cta_any_30) as "30days_cta_any"
     , SUM(cta_any_07) as "7days_cta_any"
     , (CASE WHEN SUM(imp_cnt_90) > 0 THEN (SUM(cta_any_90) / SUM(imp_cnt_90) / 1000) ELSE 0 END) as "90days_cta_any per 1000_national engagement impressions"
     , (CASE WHEN SUM(imp_cnt_30) > 0 THEN (SUM(cta_any_30) / SUM(imp_cnt_30) / 1000) ELSE 0 END) as "30days_cta_any per 1000_national engagement impressions"
     , (CASE WHEN SUM(imp_cnt_07) > 0 THEN (SUM(cta_any_07) / SUM(imp_cnt_07) / 1000) ELSE 0 END) as "7days_cta_any per 1000_national engagement impressions"
     , (CASE WHEN SUM(click_cnt_90) > 0 THEN SUM(cta_any_90) / SUM(click_cnt_90) ELSE 0 END) as "90days_cta_any per national engagement clicks"
     , (CASE WHEN SUM(click_cnt_30) > 0 THEN SUM(cta_any_30) / SUM(click_cnt_30) ELSE 0 END) as "30days_cta_any per national engagement clicks"
     , (CASE WHEN SUM(click_cnt_07) > 0 THEN SUM(cta_any_07) / SUM(click_cnt_07) ELSE 0 END) as "7days_cta_any per national engagement clicks"
     , SUM(e_refresh) as "refresh"
     , SUM(e_cta_tap_refresh) as "cta_tap_refresh"
     , SUM(e_cta_map) as "cta_map"
     , SUM(e_cta_lp) as "cta_lp"
     , SUM(e_cta_call) as "cta_call"
     , SUM(e_cta_cal) as "cta_cal"
     , SUM(e_cta_video) as "cta_video"
     , SUM(e_cta_face) as "cta_face"
     , SUM(e_cta_twit) as "cta_twit"
     , SUM(e_cta_email) as "cta_email"
     , SUM(e_cta_txt) as "cta_txt"
     , SUM(e_cta_tap) as "cta_tap"
     , SUM(e_cta_swipe) as "cta_swipe"
     , SUM(e_cta_save_coupon) as "cta_save_coupon"
     --, SUM(e_cta_send_coupon) as "E Cta send Coupon"
     , SUM(e_duration) as "duration"
     , SUM(e_error) as "error"
     , SUM(e_video0) as "video0"
     , SUM(e_video25) as "video25"
     , SUM(e_video50) as "video50"
     , SUM(e_video75) as "video75"
     , SUM(e_video100) as "video100"
     , max(dt_lastchange) as dt_lastchange
FROM adsops.weekly_agg_publisher_performance_national_engagement
WHERE is_active = true
  AND start_date_sk = $P{p_start_date_sk}::int
  AND (publisher_id IN (select unnest(string_to_array($P{p_publisher_ids}, ','))::int) OR '0' = $P{p_publisher_ids})
  AND (property_id IN (select unnest(string_to_array($P{p_property_ids}, ','))::int) OR '0' = $P{p_property_ids})
  AND (channel_id IN (select unnest(string_to_array($P{p_channel_ids}, ','))::int) OR '0' = $P{p_channel_ids})
GROUP BY year_week,start_date_sk, publisher_id, publisher_name, property_id, property_name, partner_keyword
       , channel_id, channel_name, ad_network_chain_id, ad_network_chain_name
ORDER BY  publisher_name, property_name, partner_keyword, channel_name, ad_network_chain_name;]]>
	</queryString>
	<field name="Week" class="java.lang.String"/>
	<field name="Publisher ID" class="java.lang.Integer"/>
	<field name="Publisher Name" class="java.lang.String"/>
	<field name="Property ID" class="java.lang.Integer"/>
	<field name="Property Name" class="java.lang.String"/>
	<field name="Partner Keyword" class="java.lang.String"/>
	<field name="Channel ID" class="java.lang.Integer"/>
	<field name="Channel Name" class="java.lang.String"/>
	<field name="Chain ID" class="java.lang.Integer"/>
	<field name="Chain Name" class="java.lang.String"/>
	<field name="90days_Requests" class="java.math.BigDecimal"/>
	<field name="30days_Requests" class="java.math.BigDecimal"/>
	<field name="7days_Requests" class="java.math.BigDecimal"/>
	<field name="90days_Deliveries" class="java.math.BigDecimal"/>
	<field name="30days_Deliveries" class="java.math.BigDecimal"/>
	<field name="7days_Deliveries" class="java.math.BigDecimal"/>
	<field name="90days_Impressions" class="java.math.BigDecimal"/>
	<field name="30days_Impressions" class="java.math.BigDecimal"/>
	<field name="7days_Impressions" class="java.math.BigDecimal"/>
	<field name="90days_Clicks" class="java.math.BigDecimal"/>
	<field name="30days_Clicks" class="java.math.BigDecimal"/>
	<field name="07days_Clicks" class="java.math.BigDecimal"/>
	<field name="90days_cta_any" class="java.math.BigDecimal"/>
	<field name="30days_cta_any" class="java.math.BigDecimal"/>
	<field name="7days_cta_any" class="java.math.BigDecimal"/>
	<field name="90days_cta_any per 1000_national engagement impressions" class="java.math.BigDecimal"/>
	<field name="30days_cta_any per 1000_national engagement impressions" class="java.math.BigDecimal"/>
	<field name="7days_cta_any per 1000_national engagement impressions" class="java.math.BigDecimal"/>
	<field name="90days_cta_any per national engagement clicks" class="java.math.BigDecimal"/>
	<field name="30days_cta_any per national engagement clicks" class="java.math.BigDecimal"/>
	<field name="7days_cta_any per national engagement clicks" class="java.math.BigDecimal"/>
	<field name="refresh" class="java.math.BigDecimal"/>
	<field name="cta_tap_refresh" class="java.math.BigDecimal"/>
	<field name="cta_map" class="java.math.BigDecimal"/>
	<field name="cta_lp" class="java.math.BigDecimal"/>
	<field name="cta_call" class="java.math.BigDecimal"/>
	<field name="cta_cal" class="java.math.BigDecimal"/>
	<field name="cta_video" class="java.math.BigDecimal"/>
	<field name="cta_face" class="java.math.BigDecimal"/>
	<field name="cta_twit" class="java.math.BigDecimal"/>
	<field name="cta_email" class="java.math.BigDecimal"/>
	<field name="cta_txt" class="java.math.BigDecimal"/>
	<field name="cta_tap" class="java.math.BigDecimal"/>
	<field name="cta_swipe" class="java.math.BigDecimal"/>
	<field name="cta_save_coupon" class="java.math.BigDecimal"/>
	<field name="duration" class="java.math.BigDecimal"/>
	<field name="error" class="java.math.BigDecimal"/>
	<field name="video0" class="java.math.BigDecimal"/>
	<field name="video25" class="java.math.BigDecimal"/>
	<field name="video50" class="java.math.BigDecimal"/>
	<field name="video75" class="java.math.BigDecimal"/>
	<field name="video100" class="java.math.BigDecimal"/>
	<field name="dt_lastchange" class="java.sql.Timestamp"/>
	<background>
		<band/>
	</background>
	<title>
		<band height="170">
			<staticText>
				<reportElement x="0" y="0" width="4620" height="20"/>
				<textElement>
					<font isBold="true"/>
				</textElement>
				<text><![CDATA[Notes:]]></text>
			</staticText>
			<staticText>
				<reportElement x="0" y="20" width="4620" height="145"/>
				<textElement/>
				<text><![CDATA[- Requests is all incoming requests appropriate to the group
- Deliveries is all requests with disposition = 'Y' appropriate to the group
- Impressions: Using e=&imp for the count
- Clicks: Using e=&click for the count
- cta_any: Sum of all event start with "cta_" defined in this report
- cta_any per 1000_national engagement impressions: cta_any/Impressions/1000
- cta_any per national engagement clicks: cta_any/Clicks
- Exclude all flights data points that have cta_any = 0
- Exclude all flights data points that have Clicks = 0
- Exclude all interstitial flights: interstitial flights have Clicks = cta_any (group at flight level)
- National engagement flight is defined: ADM flight.network_id = 2, cta_any > 0  (group at flight level)]]></text>
			</staticText>
		</band>
	</title>
	<columnHeader>
		<band height="20"/>
	</columnHeader>
	<detail>
		<band height="20"/>
	</detail>
</jasperReport>
